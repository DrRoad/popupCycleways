---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  warning = FALSE,
  echo = FALSE,
  collapse = TRUE,
  comment = "#>"
)
library(tidyverse)
library(sf)
library(tmap)
tmap_mode("view")
piggyback::pb_download("las_top.Rds")
las_top = readRDS("las_top.Rds")
rsf = readRDS("rsf_grouped_long.Rds")
# piggyback::pb_download("rsf.Rds", "cyipt/cyipt-phase-1-data")
```

```{r, eval=FALSE}
# general analysis of data
rsf = readRDS("rsf.Rds")
names(rsf)
rtid = readr::read_csv("~/cyipt/cyipt-server-data/malcolm/roadtypes.csv")
rsf = left_join(rsf, rtid)
rsf_spare_lane = rsf %>% filter(
  (lanespsvforward + lanesforward) > 1 |
  (lanespsvbackward + lanesbackward) > 1,
  ! grepl(pattern = "motorway", highway)
  ) 
saveRDS(rsf_spare_lane, "rsf_spare_line.Rds")
# piggyback::pb_upload("rsf_spare_line.Rds", "cyipt/cyipt-phase-1-data")

rsf = readRDS("rsf_spare_line.Rds")
summary(rsf$length)
unique(rsf$region)
head(rsf$name)
rsf %>% 
  select(calcwidthnow) %>% 
  sf::st_drop_geometry() %>%
  group_by(calcwidthnow) %>% 
  summarise(n = n()) %>% 
  filter(n > 500)
wide_potential1 = rsf %>% filter(width > 10, pct.dutch > 100)
wide_potential2 = rsf %>% filter(
  (lanespsvforward + lanesforward) > 1 |
  (lanespsvbackward + lanesbackward) > 1,
  pctdutch > 50)
# mapview::mapview(wide_potential2) # very patchy
rsf_grouped = rsf %>% 
  group_by(name, ref, highway, region) %>% 
  summarise(pctgov = mean(pctgov)) %>% 
  ungroup()

rsf_grouped$length = sf::st_length(rsf_grouped) %>% as.numeric()
summary(rsf_grouped$length)
rsf_grouped_long = rsf_grouped %>% filter(length > 100)
# mapview::mapview(rsf_grouped_long)
rsf_grouped_long %>%
  st_drop_geometry() %>% 
  arrange(desc(pctgov)) %>%
  group_by(region) %>% 
  slice(1:10) 
tm_shape(rsf_grouped_long) + tm_lines("pctgov", lwd = 3, palette = "viridis")  
saveRDS(rsf_grouped_long, "rsf_grouped_long.Rds")
```


# Data analysis to support temporary cycleways

<!-- badges: start -->
<!-- badges: end -->

The goal of this project is to flag roads on which there is

- high cycling potential
- road space that could be re-allocated

in the context of increased for demand for cycling to keyworker workplaces.

It is based on an analysis of data generated for the Department for Transport funded projects the Propensity to Cycle Tool (PCT) and the Cycling Infrastructure Prioritisation Toolkit (CyIPT).

The first stage was to identify cities with high cycling potential.
We did this by analysing data from the PCT project and selecting the top 10 cities in terms of long term cycling potential, plus Sheffield and Cambridge, presented in the table and figure below:

```{r cities}
las_top %>% 
  select(name, all, bicycle, dutch_slc) %>% 
  sf::st_drop_geometry() %>%
  knitr::kable(caption = "Top 10 cities by cycling potential in England, with 'all' representing all commuters in the 2011 Census, 'bicycle' representing the number who cycled to work and 'dutch_slc' the number who could cycle to work under a 'Go Dutch' scenario of cycling uptake.")
```


```{r}
tm_shape(las_top) +
  tm_polygons("blue")
```

These 12 study cities coincidentally represent almost exactly 1/4 of the population in England.
Welsh and Scottish cities with high cycling potential such as Cardiff and Edinbugh were not included in the analysis because the CyIPT does not currently have data outside of England, although we could extend the methods to cover all UK cities at some point.

Below we show the results for a selection of cities, with cycling potential on the road network visualised under the 'Government Target' scenario, which represents a doubling in cycling compared with 2011 levels.
London is close to meeting this target already.

We filtered-out roads with low levels of cycling potential and focus only on roads that have at least one 'spare lane', defined as having more than 1 lane in either direction.
Roads that could be made oneway, or that could be converted into 'liveable streets' by preventing through traffic were not considered.


# London

```{r}
roads = rsf %>% filter(region == "London", pctgov > 500)
tm_shape(roads) + tm_lines("pctgov", lwd = 3, palette = "viridis") +
  tm_view(set.zoom.limits = c(12, 13)) + tm_scale_bar()
```

The top 10 roads:

```{r}
roads_top = roads %>%
  filter(length > 500) %>% 
  arrange(desc(pctgov)) %>%
  slice(1:10) 
tm_shape(roads_top) + tm_lines("pctgov", lwd = 3, palette = "viridis") +
  tm_text("name") +
  tm_view(set.zoom.limits = c(13, 14)) + tm_scale_bar()

roads_top %>%
  st_drop_geometry() %>% 
  knitr::kable(digits = 0)
```




# Leeds

```{r}
roads = rsf %>% filter(region == "Leeds", pctgov > 100)
tm_shape(roads) + tm_lines("pctgov", lwd = 3, palette = "viridis") +
  tm_view(set.zoom.limits = c(13, 14)) + tm_scale_bar()
```

The top 10 roads:

```{r}
roads_top = roads %>%
  filter(length > 500) %>% 
  arrange(desc(pctgov)) %>%
  slice(1:10) 
tm_shape(roads_top) + tm_lines("pctgov", lwd = 3, palette = "viridis") +
  tm_text("name") +
  tm_view(set.zoom.limits = c(13, 14)) + tm_scale_bar()

roads_top %>%
  st_drop_geometry() %>% 
  knitr::kable(digits = 0)
```

# Cambridge

```{r}
roads = rsf %>% filter(region == "Cambridge", pctgov > 400)
tm_shape(roads) + tm_lines("pctgov", lwd = 3, palette = "viridis")
```

The top 10 roads:

```{r}
roads_top = roads %>%
  filter(length > 100) %>% 
  arrange(desc(pctgov)) %>%
  slice(1:10) 
tm_shape(roads_top) + tm_lines("pctgov", lwd = 3, palette = "viridis") +
  tm_text("name") +
  tm_view(set.zoom.limits = c(13, 14)) + tm_scale_bar()

roads_top %>%
  st_drop_geometry() %>% 
  knitr::kable(digits = 0)
```
