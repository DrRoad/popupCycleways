---
title: Data analysis to support temporary cycleways
output:
  # html_document:
  github_document:
    toc: true
    toc_depth: 2
# uncomment the next line if no phantomjs
# always_allow_html: no
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  message = FALSE,
  warning = FALSE,
  echo = FALSE,
  collapse = TRUE,
  comment = "#>"
)
library(pct)
library(sf)
library(tidyverse)
library(tmap)
tmap_mode("view")
piggyback::pb_download("las_top.Rds")
pct_las = sf::read_sf("https://github.com/cyipt/tempCycleways/releases/download/0.1/pct_la_summaries.geojson")
las_top = sf::read_sf("https://github.com/cyipt/tempCycleways/releases/download/0.1/las_top.geojson")
# las_top = readRDS("las_top.Rds")
# las_top = st_make_valid(las_top)
# sf::write_sf(las_top, "las_top.geojson")
# piggyback::pb_upload("las_top.geojson")
piggyback::pb_download("rsf_grouped_long.Rds")
rsf = readRDS("rsf_grouped_long.Rds")
piggyback::pb_download("Builtup_Areas_December_2011_Boundaries_V2.geojson")
# could use in subsequent analysis - removes part of Liverpool tunnel?
# builtup = sf::read_sf("Builtup_Areas_December_2011_Boundaries_V2.geojson") %>% sf::st_transform(27700)
## Mask not required for London, so no need to slow down the code unnecessarily
s = c(
  "Esri.WorldGrayCanvas",
  "https://b.tile-cyclosm.openstreetmap.fr/cyclosm/{z}/{x}/{y}.png",
  "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}'"
)
```

```{r, eval=FALSE}

rmarkdown::render("london.Rmd") # check
rmarkdown_files = paste0(tolower(las_top$name), ".Rmd")
lapply(rmarkdown_files, rmarkdown::render)
webshot::install_phantomjs()
# general analysis of data
# piggyback::pb_download("rsf.Rds", "cyipt/cyipt-phase-1-data")
rsf = readRDS("rsf.Rds")
names(rsf)
rtid = readr::read_csv("~/cyipt/cyipt-server-data/malcolm/roadtypes.csv")
rsf = left_join(rsf, rtid)
rsf_spare_lane = rsf %>% filter(
  (lanespsvforward + lanesforward) > 1 |
    (lanespsvbackward + lanesbackward) > 1,
  !grepl(pattern = "motorway", highway)
)
saveRDS(rsf_spare_lane, "rsf_spare_line.Rds")
# piggyback::pb_upload("rsf_spare_line.Rds", "cyipt/cyipt-phase-1-data")

rsf = readRDS("rsf_spare_line.Rds")
summary(rsf$length)
unique(rsf$region)
head(rsf$name)
rsf %>%
  select(calcwidthnow) %>%
  sf::st_drop_geometry() %>%
  group_by(calcwidthnow) %>%
  summarise(n = n()) %>%
  filter(n > 500)
wide_potential1 = rsf %>% filter(width > 10, pct.dutch > 100)
wide_potential2 = rsf %>% filter(
  (lanespsvforward + lanesforward) > 1 |
    (lanespsvbackward + lanesbackward) > 1,
  pctdutch > 50)
# mapview::mapview(wide_potential2) # very patchy
rsf_grouped = rsf %>%
  group_by(name, ref, highway, region) %>%
  summarise(pctgov = mean(pctgov)) %>%
  ungroup()

rsf_grouped$length = sf::st_length(rsf_grouped) %>% as.numeric()
summary(rsf_grouped$length)
rsf_grouped_long = rsf_grouped %>% filter(length > 100)
# mapview::mapview(rsf_grouped_long)
rsf_grouped_long %>%
  st_drop_geometry() %>%
  arrange(desc(pctgov)) %>%
  group_by(region) %>%
  slice(1:10)
tm_shape(rsf_grouped_long) + tm_lines("pctgov", lwd = 3, palette = "viridis")
saveRDS(rsf_grouped_long, "rsf_grouped_long.Rds")
piggyback::pb_upload("rsf_grouped_long.Rds")
```


# Introduction

<!-- badges: start -->
<!-- badges: end -->

The goal of this project is to flag roads on which there is

- high cycling potential
- road space that could be re-allocated

in the context of increased for demand for cycling to keyworker workplaces.

It is based on an analysis of data generated for the Department for Transport funded projects the Propensity to Cycle Tool (PCT) and the Cycling Infrastructure Prioritisation Toolkit (CyIPT).

To overcome issues associated with doing this at a national level and elicit feedback on the methods and preliminary results, we ran the analysis on a sample of cities.
We chose the top 5 in terms of absolute long-term cycling potential (London, Birmingham, Manchester, Leeds, Liverpool) plus an additional 5 cities that have active advocacy groups (Newcastle, Sheffield, Cambridge, Bristol, Leicester).
Estimates of current and potential numbers who could cycle to work in these cities is presented in the table below.
<!-- We did this by analysing data from the PCT project and selecting the top 10 cities in terms of long term cycling potential, plus Sheffield and Cambridge, : -->

```{r cities}
las_top %>%
  select(name, all, bicycle, dutch_slc) %>%
  sf::st_drop_geometry() %>%
  knitr::kable(caption = "Selection of 10 cities in England with high cycling potential or active adovcacy groups. 'All' represents all commuters in the 2011 Census, 'bicycle' represents the number who cycled to work and 'dutch_slc' the number who could cycle to work under a 'Go Dutch' scenario of cycling uptake.")
```

The geographic distribution of these cities is shown in the map below:

```{r}
tm_shape(las_top) +
  tm_polygons("blue")
```

These cities represent around 1/4 of the population in England.
Welsh and Scottish cities with high cycling potential such as Cardiff and Edinbugh were not included in the analysis because the CyIPT does not currently have data outside of England, although we could extend the methods to cover all UK cities at some point.

# Method

To identify streets that may be strong candidates for the provision of temporary or 'pop-up' cycleways, building on data from the CyIPT and PCT projects, three filtering methods were used:

- Number of lanes: roads with more than 1 lane in either direction were identified
- Cycling potential: only roads with high cycling potential, of 100 or more in the long-term Government Target scenario, were selected
- Length of road: only road sections at least 100m long were included in the analysis, in some cities this threshold was raised to identify the 'top 10' roads for new cycleways

More criteria such as road width and proximity to key services such as hospitals could be added at a later date.
A final stage involved manually removing road sections such as roads on which there is already good quality dedicated infrastructure and roundabouts. This final stage could be automated in future work.

The cycling potential of the 'top 10' streets is presented in terms of the 'Government Target' scenario, which represents a doubling in cycling compared with 2011 levels.
London is close to meeting this target already.

# Interpreting the results

The results are not intended to be a definitive list of places where popup cycleways should be prioritised.
There may be 'false positives' where there are strong reasons for not converting a 'spare lane' into a cycleway or temporary pavement.
There will be many road sections that would benefit from interventions not shown in the maps below: roads with only one lane in each direction could be made oneway temporarily, creating a spare lane for cycleways or extra pavement width.


<!-- We filtered-out roads with low levels of cycling potential and focus only on roads that have at least one 'spare lane', defined as having more than 1 lane in either direction. -->
Such roads and roads that could be converted into 'liveable streets' by preventing through traffic have not been considered at this stage.
Providing evidence to identify such roads, e.g. where there is high demand but little road width, suggesting a strong argument for making them one-way during a period of vital physical distancing, in addition to the roads with 'spare lanes' identified below, could be an aim of future work.

## What the maps show

The results below show all roads with a 'spare lane' in the low average traffic conditions created by the partial lockdown (light blue) based on the three criteria listed above (lanes, potential and length) plus the top 10 roads of a minimum length in terms of estimated cycling potential under the Government Target scenario in the PCT (dark blue).  

```{r, child="london.Rmd"}

```

See [london.html](london.html) for the interactive version of the map above.


```{r, child="birmingham.Rmd"}

```

See [birmingham.html](birmingham.html) for the interactive version of the map above.


```{r, child="manchester.Rmd"}

```

See [manchester.html](manchester.html) for the interactive version of the map above.


```{r, child="leeds.Rmd"}

```

See [leeds.html](leeds.html) for the interactive version of the map above.


```{r, child="liverpool.Rmd"}

```

See [liverpool.html](liverpool.html) for the interactive version of the map above.


```{r, child="bristol.Rmd"}

```

See [bristol.html](bristol.html) for the interactive version of the map above.


```{r, child="leicester.Rmd"}

```

See [leicester.html](leicester.html) for the interactive version of the map above.


```{r, child="sheffield.Rmd"}

```

See [sheffield.html](sheffield.html) for the interactive version of the map above.


```{r, child="newcastle.Rmd"}

```

See [newcastle.html](newcastle.html) for the interactive version of the map above.


```{r, child="cambridge.Rmd"}

```

See [cambridge.html](cambridge.html) for the interactive version of the map above.


```{r, engine='zsh', eval=FALSE}
# deploy
git clone git@github.com:cyipt/tempCycleways
cd tempCycleways
git checkout --orphan gh-pages
git rm -rf .
git commit --allow-empty -m 'Initial gh-pages commit'
# git push origin gh-pages
# git checkout master
# cp -Rv ../README* . # it's 100 MB!
cp -Rv ../*.html . # it's 100 MB!
git status
ls -hal
mv README.html index.html
firefox index.html
git status
git push origin gh-pages
cd ..
echo '*.html' >> .gitignore
echo 'tempCycleways/' >> .gitignore
pandoc -o README.html README.md
```



