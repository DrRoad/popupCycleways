---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  message = FALSE,
  warning = FALSE,
  echo = FALSE,
  collapse = TRUE,
  comment = "#>"
)
library(tidyverse)
library(sf)
library(tmap)
tmap_mode("view")
piggyback::pb_download("las_top.Rds")
pct_las = sf::read_sf("https://github.com/cyipt/tempCycleways/releases/download/0.1/pct_la_summaries.geojson")
las_top = readRDS("las_top.Rds")
st_make_valid(las_top)
piggyback::pb_download("rsf_grouped_long.Rds")
rsf = readRDS("rsf_grouped_long.Rds")
piggyback::pb_download("Builtup_Areas_December_2011_Boundaries_V2.geojson")
builtup = sf::read_sf("Builtup_Areas_December_2011_Boundaries_V2.geojson") %>% sf::st_transform(27700)
```

```{r, eval=FALSE}
# general analysis of data
# piggyback::pb_download("rsf.Rds", "cyipt/cyipt-phase-1-data")
rsf = readRDS("rsf.Rds")
names(rsf)
rtid = readr::read_csv("~/cyipt/cyipt-server-data/malcolm/roadtypes.csv")
rsf = left_join(rsf, rtid)
rsf_spare_lane = rsf %>% filter(
  (lanespsvforward + lanesforward) > 1 |
  (lanespsvbackward + lanesbackward) > 1,
  ! grepl(pattern = "motorway", highway)
  ) 
saveRDS(rsf_spare_lane, "rsf_spare_line.Rds")
# piggyback::pb_upload("rsf_spare_line.Rds", "cyipt/cyipt-phase-1-data")

rsf = readRDS("rsf_spare_line.Rds")
summary(rsf$length)
unique(rsf$region)
head(rsf$name)
rsf %>% 
  select(calcwidthnow) %>% 
  sf::st_drop_geometry() %>%
  group_by(calcwidthnow) %>% 
  summarise(n = n()) %>% 
  filter(n > 500)
wide_potential1 = rsf %>% filter(width > 10, pct.dutch > 100)
wide_potential2 = rsf %>% filter(
  (lanespsvforward + lanesforward) > 1 |
  (lanespsvbackward + lanesbackward) > 1,
  pctdutch > 50)
# mapview::mapview(wide_potential2) # very patchy
rsf_grouped = rsf %>% 
  group_by(name, ref, highway, region) %>% 
  summarise(pctgov = mean(pctgov)) %>% 
  ungroup()

rsf_grouped$length = sf::st_length(rsf_grouped) %>% as.numeric()
summary(rsf_grouped$length)
rsf_grouped_long = rsf_grouped %>% filter(length > 100)
# mapview::mapview(rsf_grouped_long)
rsf_grouped_long %>%
  st_drop_geometry() %>% 
  arrange(desc(pctgov)) %>%
  group_by(region) %>% 
  slice(1:10) 
tm_shape(rsf_grouped_long) + tm_lines("pctgov", lwd = 3, palette = "viridis")  
saveRDS(rsf_grouped_long, "rsf_grouped_long.Rds")
piggyback::pb_upload("rsf_grouped_long.Rds")
```


# Data analysis to support temporary cycleways

<!-- badges: start -->
<!-- badges: end -->

The goal of this project is to flag roads on which there is

- high cycling potential
- road space that could be re-allocated

in the context of increased for demand for cycling to keyworker workplaces.

It is based on an analysis of data generated for the Department for Transport funded projects the Propensity to Cycle Tool (PCT) and the Cycling Infrastructure Prioritisation Toolkit (CyIPT).

To overcome issues associated with doing this at a national level and elicit feedback on the methods and preliminary results, we ran the analysis on a sample of cities.
We chose the top 5 in terms of absolute long-term cycling potential (London, Birmingham, Manchester, Leeds, Liverpool) plus an additional 5 cities that have active advocacy groups (Newcastle, Sheffield, Cambridge, Bristol, Leicester).
Estimates of current and potential numbers who could cycle to work in these cities is presented in the table below.
<!-- We did this by analysing data from the PCT project and selecting the top 10 cities in terms of long term cycling potential, plus Sheffield and Cambridge, : -->

```{r cities}
las_top %>% 
  select(name, all, bicycle, dutch_slc) %>% 
  sf::st_drop_geometry() %>%
  knitr::kable(caption = "Selection of 10 cities in England with high cycling potential or active adovcacy groups. 'All' represents all commuters in the 2011 Census, 'bicycle' represents the number who cycled to work and 'dutch_slc' the number who could cycle to work under a 'Go Dutch' scenario of cycling uptake.")
```

The geographic distribution of these cities is shown in the map below:

```{r}
tm_shape(las_top) +
  tm_polygons("blue")
```

These 12 study cities coincidentally represent almost exactly 1/4 of the population in England.
Welsh and Scottish cities with high cycling potential such as Cardiff and Edinbugh were not included in the analysis because the CyIPT does not currently have data outside of England, although we could extend the methods to cover all UK cities at some point.

Below we show the results for a selection of cities, with cycling potential on the road network visualised under the 'Government Target' scenario, which represents a doubling in cycling compared with 2011 levels.
London is close to meeting this target already.

We filtered-out roads with low levels of cycling potential and focus only on roads that have at least one 'spare lane', defined as having more than 1 lane in either direction.
Roads that could be made oneway, or that could be converted into 'liveable streets' by preventing through traffic were not considered.


# London

```{r}
##Mask not required for London, so no need to slow down the code unnecessarily
# london_centroids = get_pct_centroids("london",geography = "lsoa") %>% sf::st_transform(27700)
# london_lsoa_buff = st_buffer(x = london_centroids, dist = 1000)
# london_res_buff = st_intersection(builtup,london_lsoa_buff) %>% st_union()
roads = rsf %>% filter(region == "London", pctgov > 500)
# roads = roads %>% st_transform(27700) %>% st_intersection(london_res_buff) %>% st_transform(4326)
tm_shape(roads) + tm_lines("pctgov", lwd = 3, palette = "viridis") +
  tm_view(set.view = 11) + tm_scale_bar()
```

The top 10 roads:

```{r}
roads_top = roads %>%
  filter(length > 500) %>% 
  filter(!name == "Talgarth Road", length > 500) %>% 
  arrange(desc(pctgov)) %>%
  slice(1:10) 
tm_shape(roads_top) + tm_lines("pctgov", lwd = 3, palette = "viridis") +
  tm_text("name") +
  tm_view(set.view = 12) + tm_scale_bar()

roads_top %>%
  st_drop_geometry() %>% 
  select(name, ref, road_type = highway, cycling_potential = pctgov, length_m = length) %>% knitr::kable(digits = 0)
```

# Birmingham

```{r}
birmingham_centroids = get_pct_centroids("west-midlands",geography = "lsoa") %>% sf::st_transform(27700)
birmingham_lsoa_buff = st_buffer(x = birmingham_centroids, dist = 1000)
birmingham_res_buff = st_intersection(builtup,birmingham_lsoa_buff) %>% st_union()
roads = rsf %>% filter(region == "Birmingham", pctgov > 100)
roads = roads %>% st_transform(27700) %>% st_intersection(birmingham_res_buff) %>% st_transform(4326)
tm_shape(roads) + tm_lines("pctgov", lwd = 3, palette = "viridis") +
  tm_view(set.view = 12) + tm_scale_bar()
```

The top 10 roads:

```{r}
roads_top = roads %>%
  filter(length > 300) %>% 
  arrange(desc(pctgov)) %>%
  slice(1:10) 
tm_shape(roads_top) + tm_lines("pctgov", lwd = 3, palette = "viridis") +
  tm_text("name") +
  tm_view(set.view = 13) + tm_scale_bar()

roads_top %>%
  st_drop_geometry() %>% 
  select(name, ref, road_type = highway, cycling_potential = pctgov, length_m = length) %>% knitr::kable(digits = 0)
```

# Manchester

```{r}
manchester_centroids = get_pct_centroids("greater-manchester",geography = "lsoa") %>% sf::st_transform(27700)
manchester_lsoa_buff = st_buffer(x = manchester_centroids, dist = 1000)
manchester_res_buff = st_intersection(builtup,manchester_lsoa_buff) %>% st_union()
roads = rsf %>% filter(region == "Manchester", pctgov > 100)
roads = roads %>% st_transform(27700) %>% st_intersection(manchester_res_buff) %>% st_transform(4326)
region_centre = tmaptools::geocode_OSM("Manchester", as.sf = TRUE)
region_buff = stplanr::geo_buffer(region_centre, dist = 7000)
roads = st_intersection(roads, region_buff)
tm_shape(roads) + tm_lines("pctgov", lwd = 3, palette = "viridis") +
  tm_view(set.view = 12) + tm_scale_bar()
```

The top 10 roads:

```{r}
roads_top = roads %>%
  filter(length > 300) %>% 
  arrange(desc(pctgov)) %>%
  slice(1:10) 
tm_shape(roads_top) + tm_lines("pctgov", lwd = 3, palette = "viridis") +
  tm_text("name") +
  tm_view(set.view = 13) + tm_scale_bar()

roads_top %>%
  st_drop_geometry() %>% 
  select(name, ref, road_type = highway, cycling_potential = pctgov, length_m = length) %>% knitr::kable(digits = 0)
```


# Leeds

```{r}
leeds_centroids = get_pct_centroids("west-yorkshire",geography = "lsoa") %>% sf::st_transform(27700)
leeds_lsoa_buff = st_buffer(x = leeds_centroids$geometry, dist = 1000)
leeds_res_buff = st_intersection(builtup,leeds_lsoa_buff) %>% st_union()
roads = rsf %>% filter(region == "Leeds", pctgov > 100)
roads = roads %>% st_transform(27700) %>% st_intersection(leeds_res_buff) %>% st_transform(4326)
region_centre = tmaptools::geocode_OSM("Leeds", as.sf = TRUE)
region_buff = stplanr::geo_buffer(region_centre, dist = 3000)
roads = st_intersection(roads, region_buff)
tm_shape(roads) + tm_lines("pctgov", lwd = 3, palette = "viridis") +
  tm_scale_bar()
```

The top 10 roads:

```{r}
region_centre = tmaptools::geocode_OSM("Leeds", as.sf = TRUE)
region_buff = stplanr::geo_buffer(region_centre, dist = 3000)
roads_top = roads %>%
  filter(length > 300) %>% 
  arrange(desc(pctgov)) %>%
  slice(1:10) 
tm_shape(roads_top) + tm_lines("pctgov", lwd = 3, palette = "viridis") +
  tm_text("name") +
  tm_view(set.view = 13) + tm_scale_bar()

roads_top %>%
  st_drop_geometry() %>% 
  select(name, ref, road_type = highway, cycling_potential = pctgov, length_m = length) %>% knitr::kable(digits = 0)
```

# Liverpool

```{r}
liverpool_centroids = get_pct_centroids("liverpool-city-region",geography = "lsoa") %>% sf::st_transform(27700)
liverpool_lsoa_buff = st_buffer(x = liverpool_centroids, dist = 1000)
liverpool_res_buff = st_intersection(builtup,liverpool_lsoa_buff) %>% st_union()
roads = rsf %>% filter(region == "Liverpool", pctgov > 100)
region_centre = tmaptools::geocode_OSM("Liverpool", as.sf = TRUE)
region_buff = stplanr::geo_buffer(region_centre, dist = 9000)
roads = st_intersection(roads, region_buff)
roads = roads %>% st_transform(27700) %>% st_intersection(liverpool_res_buff) %>% st_transform(4326)
tm_shape(roads) + tm_lines("pctgov", lwd = 3, palette = "viridis") +
  tm_view(set.view = 12) + tm_scale_bar()
```

The top 10 roads:

```{r}
roads_top = roads %>%
  filter(length > 300) %>% 
  arrange(desc(pctgov)) %>%
  slice(1:10) 
tm_shape(roads_top) + tm_lines("pctgov", lwd = 3, palette = "viridis") +
  tm_text("name") +
  tm_view(set.view = 12) + tm_scale_bar()

roads_top %>%
  st_drop_geometry() %>% 
  select(name, ref, road_type = highway, cycling_potential = pctgov, length_m = length) %>% knitr::kable(digits = 0)
```

# Bristol

```{r}
bristol_centroids = get_pct_centroids("avon",geography = "lsoa") %>% sf::st_transform(27700)
bristol_lsoa_buff = st_buffer(x = bristol_centroids, dist = 1000)
bristol_res_buff = st_intersection(builtup,bristol_lsoa_buff) %>% st_union()
region = pct_las %>% filter(name == "Bristol")
region = sf::st_make_valid(region)
roads = rsf %>% filter(region == "Bristol", pctgov > 100)
roads = roads[region, ]
roads = st_intersection(roads, region)
roads = roads %>% st_transform(27700) %>% st_intersection(bristol_res_buff) %>% st_transform(4326)
tm_shape(roads) + tm_lines("pctgov", lwd = 3, palette = "viridis") +
  tm_shape(region) + tm_borders() +
  tm_scale_bar() 
```

The top 10 roads:

```{r}
bristol_centre = tmaptools::geocode_OSM("Bristol", as.sf = TRUE)
bristol_buff = stplanr::geo_buffer(bristol_centre, dist = 1500)
roads_top = roads[bristol_buff, ] %>%
  filter(length > 300) %>% 
  filter(!name == "Bond Street", !name == "") %>% 
  arrange(desc(pctgov)) %>%
  slice(2:11) %>% 
  distinct(name, .keep_all = TRUE)
tm_shape(roads_top) + tm_lines("pctgov", lwd = 3, palette = "viridis") +
  tm_text("name") +
  tm_scale_bar()

roads_top %>%
  st_drop_geometry() %>% 
  select(name, ref, road_type = highway, cycling_potential = pctgov, length_m = length) %>% knitr::kable(digits = 0)
```


# Leicester

```{r}
leicester_centroids = get_pct_centroids("leicestershire",geography = "lsoa") %>% sf::st_transform(27700)
leicester_lsoa_buff = st_buffer(x = leicester_centroids, dist = 1000)
leicester_res_buff = st_intersection(builtup,leicester_lsoa_buff) %>% st_union()
roads = rsf %>% filter(region == "Leicester", pctgov > 100)
region_centre = tmaptools::geocode_OSM("Leicester", as.sf = TRUE)
region_buff = stplanr::geo_buffer(region_centre, dist = 9000)
roads = st_intersection(roads, region_buff)
roads = roads %>% st_transform(27700) %>% st_intersection(leicester_res_buff) %>% st_transform(4326)
tm_shape(roads) + tm_lines("pctgov", lwd = 3, palette = "viridis") +
  tm_view(set.view = 12) + tm_scale_bar()
```

The top 10 roads:

```{r}
roads_top = roads %>%
  filter(length > 300) %>% 
  arrange(desc(pctgov)) %>%
  slice(1:10) 
tm_shape(roads_top) + tm_lines("pctgov", lwd = 3, palette = "viridis") +
  tm_text("name") +
  tm_view(set.view = 12) + tm_scale_bar()

roads_top %>%
  st_drop_geometry() %>% 
  select(name, ref, road_type = highway, cycling_potential = pctgov, length_m = length) %>% knitr::kable(digits = 0)
```

# Sheffield

```{r}
sheffield_centroids = get_pct_centroids("south-yorkshire",geography = "lsoa") %>% sf::st_transform(27700)
sheffield_lsoa_buff = st_buffer(x = sheffield_centroids, dist = 1000)
sheffield_res_buff = st_intersection(builtup,sheffield_lsoa_buff) %>% st_union()
roads = rsf %>% filter(region == "Sheffield", pctgov > 100)
region_centre = tmaptools::geocode_OSM("Sheffield", as.sf = TRUE)
region_buff = stplanr::geo_buffer(region_centre, dist = 9000)
roads = st_intersection(roads, region_buff)
roads = roads %>% st_transform(27700) %>% st_intersection(sheffield_res_buff) %>% st_transform(4326)
tm_shape(roads) + tm_lines("pctgov", lwd = 3, palette = "viridis") +
  tm_view(set.view = 12) + tm_scale_bar()
```

The top 10 roads:

```{r}
roads_top = roads %>%
  filter(length > 600) %>% 
  arrange(desc(pctgov)) %>%
  slice(1:10) 
tm_shape(roads_top) + tm_lines("pctgov", lwd = 3, palette = "viridis") +
  tm_text("name") +
  tm_view(set.view = 12) + tm_scale_bar()

roads_top %>%
  st_drop_geometry() %>% 
  select(name, ref, road_type = highway, cycling_potential = pctgov, length_m = length) %>% knitr::kable(digits = 0)
```

# Newcastle

```{r}
newcastle_centroids = get_pct_centroids("north-east",geography = "lsoa") %>% sf::st_transform(27700)
newcastle_lsoa_buff = st_buffer(x = newcastle_centroids, dist = 1000)
newcastle_res_buff = st_intersection(builtup,newcastle_lsoa_buff) %>% st_union()
roads = rsf %>% filter(region == "Newcastle", pctgov > 100)
region_centre = tmaptools::geocode_OSM("Newcastle", as.sf = TRUE)
region_buff = stplanr::geo_buffer(region_centre, dist = 9000)
roads = st_intersection(roads, region_buff)
roads = roads %>% st_transform(27700) %>% st_intersection(newcastle_res_buff) %>% st_transform(4326)
tm_shape(roads) + tm_lines("pctgov", lwd = 3, palette = "viridis") +
  tm_view(set.view = 12) + tm_scale_bar()
```

The top 10 roads:

```{r}
roads_top = roads %>%
  filter(length > 600) %>% 
  filter(!name == "") %>% 
  arrange(desc(pctgov)) %>%
  group_by(name, ref, highway) %>% 
  summarise(pctgov = mean(pctgov), length = mean(length)) %>% 
  ungroup() %>% 
  slice(1:10) 
tm_shape(roads_top) + tm_lines("pctgov", lwd = 3, palette = "viridis") +
  tm_text("name") +
  tm_view(set.view = 12) + tm_scale_bar()

roads_top %>%
  st_drop_geometry() %>% 
  select(name, ref, road_type = highway, cycling_potential = pctgov, length_m = length) %>% knitr::kable(digits = 0)
```



# Cambridge

```{r}
cambridge_centroids = get_pct_centroids("cambridgeshire",geography = "lsoa") %>% sf::st_transform(27700)
cambridge_lsoa_buff = st_buffer(x = cambridge_centroids, dist = 1000)
cambridge_res_buff = st_intersection(builtup,cambridge_lsoa_buff) %>% st_union()
roads = rsf %>% filter(region == "Cambridge", pctgov > 400)
roads = roads %>% st_transform(27700) %>% st_intersection(cambridge_res_buff) %>% st_transform(4326)
tm_shape(roads) + tm_lines("pctgov", lwd = 3, palette = "viridis") +
  tm_view(set.view = 13) + tm_scale_bar()
```

The top 10 roads:

```{r}
roads_top = roads %>%
  filter(length > 100) %>% 
  arrange(desc(pctgov)) %>%
  slice(1:10) 
tm_shape(roads_top) + tm_lines("pctgov", lwd = 3, palette = "viridis") +
  tm_text("name") +
  tm_view(set.view = 14) + tm_scale_bar()

roads_top %>%
  st_drop_geometry() %>% 
  select(name, ref, road_type = highway, cycling_potential = pctgov, length_m = length) %>% knitr::kable(digits = 0)
```


