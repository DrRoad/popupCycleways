---
title: "Rapid cycleway prioritisation tool"
author: "Dr Robin Lovelace & Dr Joey Talbot, Institute for Transport Studies, University of Leeds"
output: 
  html_document: 
    toc: yes
bibliography: 
  # - index.bib
  - ../refs.bib
---

```{r, eval=FALSE, echo=FALSE}
citr::tidy_bib_file("~/uaf/allrefs.bib", rmd_file = "code/index.Rmd", file = "code/index.bib")
```

```{r setup, include=FALSE}
knitr::opts_knit$set(root.dir = "..")
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
```

```{r pkg, include=FALSE}
library(sf)
library(tidyverse)
library(tmap)
tmap_mode("view")
```

```{r, eval=FALSE}
# test build works before running for all:
source("code/build.R")
```

```{r bibs, engine='bash', eval=FALSE}
bibtool
ls *.bib
bibtool refs.bib report-refs.bib code/index.bib > refs.bib
```


# Introduction

The [rapid cycleway prioritisation tool](https://www.cyipt.bike/rapid/) helps identify road sections for road space reallocation and other interventions to create new cycleways.
Used with local knowledge, it provides a strong evidence base to support planning of rapid measures to support safe travel as part of the COVID-19 response.
In the context of COVID-19, big decisions need to be made **rapidly**.

The rapid cycleway prioritisation tool aims to help produce evidence-based answers the question: **where to reallocate road space on arterial routes away from motor traffic and towards active transport?**
The focus of the tool is road space reallocation on strategic corridors, a key way in which transport systems can be transformed to overcome capacity constraints on public transport modes and prevent gridlock as the lockdown eases.

Reallocating road space on strategic corridors is just one of the measures available for transport authorities.
Evidence provided by the tool can also support a range of temporary, experimental and permanent treatments that will enable shift to walking and cycling in the coming weeks and months.
New [statutory guidance on network management in response to COVID-19](https://www.gov.uk/government/publications/reallocating-road-space-in-response-to-covid-19-statutory-guidance-for-local-authorities/traffic-management-act-2004-network-management-in-response-to-covid-19) outlines a range of measures, including the creation of new cycleways, reducing speed limits, widening of footways and closing roads to motor traffic via 'modal filters'.
Road space reallocation is suited to larger arterial roads and can have a large impact quickly, especially when moving large numbers of people away from public transport and capacity is a priority.
Furthermore, low but gradually increasing levels of peak hour motor traffic mean that there is a window of opportunity to reallocate lanes without causing congestion. 


<!-- # Input data -->

The focus is on roads that have 'spare space' (defined as those with a spare lane or that have an estimated width of above 10 m) and high cycling potential based on the [Propensity to Cycle Tool](https://www.pct.bike/) [@lovelace_propensity_2017].
The 10 m width is an indicator of road conditions and larger widths, of 15+ m, may be required for road space reallocation without other changes such as making roads one way for motor traffic or removing [central markings](https://doi.org/10.1016/j.aap.2014.08.015) [@shackel_influence_2014].
Which roads to prioritise and the most effective interventions will also depend on factors such as on street parking levels not present in the analysis.

The cycling potential of each road is based on data from the Propensity to Cycle Tool (see [www.pct.bike](https://www.pct.bike/) for further details) and represents the number of one way cycle trips to work and school that could be expected when the [Government's aim of doubling cycling is met](https://www.gov.uk/government/publications/cycling-and-walking-investment-strategy).
The scenario assumes cycling grows evenly nationwide accounting for distance and hilliness.
Our figures include data on travel to work from 2011 Census data and travel to school. Data on road widths and number of lanes is derived from the Cycling Infrastructure Prioritisation Toolkit.

Overall the evidence presented in the tool is designed to encourage bold interventions where more space for active modes is most needed.
Currently the results are only available for England.
<!-- The work is based evidence that road space can be reallocated without causing congestion at a time when traffic levels, particularly during the rush hours, are greatly reduced. -->

# How to use the tool

To use the evidence generated for this project:

- Type in the name of the local authority of interest into the search bar above the table below and click on the associated URL.
- Explore the results in the map (you will find a link to a full screen map) by panning, zooming and clicking on the layers. See additional layers by clicking on the layers icon in the top left of the map.
- Rank the 'top roads' in various ways (including by length and cycling potential) to support prioritisation of road space reallocation schemes.
- Interpret the results with care based on other sources of information and an understanding of the limitations of the analysis (see 'Known issues and limitations' below).
- Refer to the description of the map layers below when exploring the results and complete the [web form](https://urldefense.proofpoint.com/v2/url?u=https-3A__forms.office.com_Pages_ResponsePage.aspx-3Fid-3DqO3qvR3IzkWGPlIypTW3y9orQ9urif9IgBaXiRS9eEpUM0JCTDRFTTEwSDRVMUs0VVhVWEdGRDA3RS4u&d=DwMCaQ&c=troKkvwivNn_CddsvWCHHPiPoFoTgTGIbXJULvYU158&r=DXeEYtdSYDBZN2DBwEgAHMmX5PQ_ob9r2MynFWta2mU&m=mkyUa3RIC9d5LSrHUqk_WdstQR1OQuTWyYLBecHFMm0&s=dD7GVcQbjZ2AcdCObSe-rNKmLLDBhu98ChFupIIrlJA&e=) with any feedback.

# Map layers

The maps contain five layers (two of which are hidden by default) that provide the results of our analysis, overlaying the basemaps. 
Clicking on the lines on the map for any of these layers will reveal a pop-up box containing more information about the road or segment of interest.

The three main layers are arranged in order of planning timescales:

1. The **Existing cycleways** layer provides an approximation of where cycling infrastructure exists **in the recent past** and is intended to help identify gaps in the network that could be filled with new interventions.
2. The **Top ranked new cycleways** layer is the central result of the analysis, providing a list of roads that have high cycling potential, a minimum threshold length, and spare space according to our definition. These may be strong candidates for reallocation of road space **immediately or in the near future** to create new cycleways on strategic corridors under the first and second tranches of funding.
3. The **Cohesive network** layer is intended to show what a joined-up cycle network could look like, if road space was not a constraint on creating new infrastructure. Composed of roads that have high cycling potential on some or all of their length, the layer is designed to guide **long term planning** towards a continuous and coherent network.

These main layers, and two other layers that informed the results but which are not shown be default, are described in detail below.

## 1. Existing cycleways

On the basis that plans should build on and extend existing provision, this layer shows existing cycleways.
This may be helpful to view in connection with the other layers, because it can reveal where gaps in the existing cycle network could be filled by new infrastructure.
This layer does not include some on-road cycle lanes or cycleways less than 500m in length, but these can be viewed in one of the basemap options (see below for more information about the basemaps).
The definition of 'cycleway' includes shared use paths but excludes cycle lanes painted on roads in this layer.

## 2. Top ranked new cycleways

These are the 'top n' road sections in terms of cycling potential with 'spare space' defined above.
They may be suitable candidates for road space reallocation to create new cycleways. 
These roads have either a spare lane or width of at least 10m, and are ranked according to their mean cycling potential. 
For routes that are shorter than 1km in length, we use 'km_cycled' instead of mean cycling potential - this is simply the mean cycling potential multiplied by the length of the route. 
Top ranked new cycleways are listed in the table below the map, so you can see more information on them. 
The number of Top ranked new cycleways selected is normally 20, with some variation by region.

We used certain eligibility criteria for the Top ranked new cycleways: 

- a road which already has an existing cycleway alongside the majority of its length cannot be a top route. 
- unnamed roads cannot be a top route 
- routes less than 500m in length cannot be a top route

## 3. Cohesive network

This layer is designed to represent a cohesive network of direct routes.
It shows what a joined-up cycle network could look like if there were no constraints on road space, along some of the most important corridors.

The layer takes no account spare space and is designed to support consideration of alternative options, e.g. one way streets, where there may be insufficient space for road space reallocation without changing the navigable network for motor traffic.
The cohesive network layer was created based on evidence that cohesive cycle networks, that are continuous and do not 'give up' at awkward junctions, are a key component of plans to get people cycling.

The layer was generated by first identifying the roads (classified by reference number) on which there is most cycling potential accross the city and joining them together.
Specifically we first selected all road segments with cycle potential in the 85th percentile and above, which also belong to classified trunk roads, A roads or B roads.
These segments are then joined together to form a continuous network.

## 3. Spare lane(s) (not shown by default)

These are routes that have more than one vehicle lane in either direction and have a cycling potential above the minimum threshold (which varies according to region as it needs to be higher in e.g. Greater London than in rural areas).

## 4. Width >= 10m (not shown by default)

These routes are at least 10m in width and have a cycling potential above the minimum threshold. 

# Basemaps

There are also seven basemaps to choose from. The default basemap is grey and provides an uncluttered view. We then have basemap options showing four different scenarios from the Propensity to Cycle Tool. This allows our results to be compared with cycling potentials across the road network. The scenarios available show cycling potential for Commuting (government target), Schools (government targets), Commuting (e-bikes), and schools (Go Dutch).

A further basemap option shows all existing cycleways, including on-road cycle lanes. Finally, a satellite image is also available as a basemap.


# Known issues and limitations

<!-- We have developed this evidence base rapidly and -->

- The 'Top ranked new cycleways' highlighted in the map-based results were produced automatically based on a simple score of continuous candidate road length multiplied by cycling potential. For roads with a length of more than 1 km, the cycling potential alone is used to rank roads. **The results should be interpreted based on local knowledge and an understanding of the limitations of the data. The results are designed to complement not replace other factors such as feedback from the local community and long-term strategic cycle network plans.**
- The estimates of cycling potential only include school and work travel. Accounting for increases in cycling for other trip purposes such as for shopping and leisure would increase cycling potential substantially.
- The results rely on grouping roads by proximity, name and other variables. Currently some roads that are strong candidates for new cycleways may be missing from the results because of how the algorithm works (we are working on this issue).
- The road network data was taken from the Cycling Infrastructure Prioritisation Toolkit (CyIPT) project which was completed in 2017, so may be out of date (we are looking at ways to update the data).
- The results are based on the existing road network and does not flag potential routes that could be constructed.

<!-- Like many projects that have been initiated in response to COVID-19 we have developed the analy -->

If you find any other issues with the results or have suggestions of ways to improve the results, please provide feedback on the [web form](https://forms.office.com/Pages/ResponsePage.aspx?id=qO3qvR3IzkWGPlIypTW3y9orQ9urif9IgBaXiRS9eEpUM0JCTDRFTTEwSDRVMUs0VVhVWEdGRDA3RS4u).
If you are interested in the code underlying the project and would like to support the project with technical input, please provide feedback via the [GitHub issue tracker (requires a GitHub account)](https://github.com/cyipt/popupCycleways/issues).


```{r}
regions = readRDS("regions_dft.Rds")
regions_centroids = sf::st_point_on_surface(regions)
regions$html_name = tolower(gsub(pattern = " |, ", replacement = "-", regions$Name))
regions$url = paste0("<a href='", regions$html_name ,"' target='_blank'>", regions$Name, "</a>")
```

```{r}
pvars = c("Name", "Level")
tm_shape(regions) + tm_polygons("Level", popup.vars = pvars) 
  # + tm_shape(regions_centroids) + tm_text("Name", size = 0.7)
```

```{r}
dn = "popupCycleways/v1" # dirctory name
built_regions = list.files(dn)
regions = regions %>% 
  filter(stringr::str_detect(string = Name, "Scilly", negate = TRUE))
regions %>%
  sf::st_drop_geometry() %>%
  # filter(html_name %in% built_regions) %>% 
  select(Name, Level, url) %>% 
  arrange(Name) %>% 
  DT::datatable(escape = -4)
```

```{r, eval=FALSE}
dir.create(dn)
region_names_to_build = regions$Name
# region_names_to_build = regions$Name[!regions$html_name %in% built_regions]
sample_to_build_regex = "west of|west y|west mid|hereford|nott|leic|manc|liv|cam|bright|suff"
region_names_to_build = regions %>%
  filter(grepl(pattern = sample_to_build_regex, x = Name, ignore.case = TRUE)) %>%
  pull(Name)
# region_names_to_build = c("West Yorkshire", "Nottingham")
# region_names_to_build = c("Greater London", "Cambridgeshire")
regions_within_names = c("Leicester", "Nottingham", "Derby", "Stoke-on-Trent")
names(regions_within_names) = c(paste0(regions_within_names[1:3], "shire"), "Staffordshire")
regions_containing_names = names(regions_within_names)
names(regions_containing_names) = regions_within_names

rn = "West of England"
for(rn in region_names_to_build) {
  region = regions %>% filter(Name == rn)
  if(rn %in% c(regions_within_names)) {
    region$geometry = sf::st_union(
      region,
      regions %>% filter(Name == regions_containing_names[rn])
      ) %>% sf::st_geometry()
  }
  t = Sys.time()
  message("Building for ", rn)
  d = file.path(dn, region$html_name)
  dir.create(d)
  region_name = region$Name
  # source("code/build.R")
  rmarkdown::render(input = "code/build.R", output_dir = d, knit_root_dir = ".")
  plot(sf::st_geometry(r_lanes_top))
  htmlwidgets::saveWidget(m_leaflet, file.path("~/cyipt/tempCycleways/", d, "m.html"))
  time_to_run = Sys.time() - t
  rmarkdown::render("code/region_index.Rmd", output_file = file.path("~/cyipt/tempCycleways/", d, "index.html"))
  sf::write_sf(cycleways, file.path(d, "cycleways.geojson"))
  sf::write_sf(top_routes, file.path(d, "top_routes.geojson"))
  sf::write_sf(key_network_final, file.path(d, "cohesive_network.geojson"))
  sf::write_sf(spare_lanes_final, file.path(d, "spare_lanes.geojson"))
  sf::write_sf(wide_lanes_final, file.path(d, "wide_lanes.geojson"))
  message(round(time_to_run), " minutes to build ", rn)
}
rmarkdown::render("code/index.Rmd", output_dir = dn)
browseURL(file.path(dn, "index.html"))
```

```{r, eval=FALSE}
# rebuild results based on pre-processed data (wip)
for(rn in region_names_to_build) {
  region = regions %>% filter(Name == rn)
  if(rn %in% c(regions_within_names)) {
    region$geometry = sf::st_union(
      region,
      regions %>% filter(Name == regions_containing_names[rn])
      ) %>% sf::st_geometry()
  }
  t = Sys.time()
  message("Building for ", rn)
  d = file.path(dn, region$html_name)
  dir.create(d)
  region_name = region$Name
  # source("code/build.R")
  rmarkdown::render(input = "code/build.R", output_dir = d, knit_root_dir = ".")
  plot(sf::st_geometry(r_lanes_top))
  htmlwidgets::saveWidget(m_leaflet, file.path("~/cyipt/tempCycleways/", d, "m.html"))
  time_to_run = Sys.time() - t
  rmarkdown::render("code/region_index.Rmd", output_file = file.path("~/cyipt/tempCycleways/", d, "index.html"))
  sf::write_sf(cycleways, file.path(d, "cycleways.geojson"))
  sf::write_sf(top_routes, file.path(d, "top_routes.geojson"))
  sf::write_sf(key_network_final, file.path(d, "cohesive_network.geojson"))
  sf::write_sf(spare_lanes_final, file.path(d, "spare_lanes.geojson"))
  sf::write_sf(wide_lanes_final, file.path(d, "wide_lanes.geojson"))
  message(round(time_to_run), " minutes to build ", rn)
}
m =
  tm_shape(lads, name = "Local authority district boundaries") + tm_borders() +
  tm_shape(key_network_final, name = "Cohesive network") +
  tm_lines(lwd = 5, col = "darkgrey", popup.vars = pvars_key) +
  tm_shape(spare_lanes_final, name = labels[2]) +
  tm_lines(legend.col.show = FALSE,
           col = cols_status[2], 
           lwd = 3,
           alpha = 1,
           popup.vars = pvars_spare,
           group = labels[2]
           ) +
  tm_shape(wide_lanes_final, name = labels[2]) +
  tm_lines(legend.col.show = FALSE,
           col = cols_status[3], 
           lwd = 3,
           alpha = 1,
           popup.vars = pvars_spare,
           group = labels[3]
  ) +
  tm_shape(cycleways, name = cycleways_name) + tm_lines(popup.vars = c("surface", "name", "osm_id"), col = "darkgreen", lwd = 1.3) +
  tm_shape(top_routes, name = "Top routes") +
  tm_lines(legend.col.show = FALSE,
           col = cols_status[1], 
           lwd = 5,
           alpha = 1,
           popup.vars = popup.vars
  ) +
  tm_basemap(server = s, tms = tms) +
  tm_add_legend(type = "fill", labels = legend_labels[1:3], col = legend_colours[1:3]) +
  tm_add_legend(type = "fill", labels = labels[2], col = legend_colours[4], group = labels[2]) +
  tm_add_legend(type = "fill", labels = labels[3], col = legend_colours[5], group = labels[3]) +
  tm_scale_bar() 
# m
m_leaflet = tmap_leaflet(m) %>% leaflet::hideGroup(labels[2:3])
```


# References


