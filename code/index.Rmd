---
title: "Rapid cycleway prioritisation tool"
author: "Dr Robin Lovelace & Dr Joey Talbot, Institute for Transport Studies, University of Leeds"
output: 
  html_document: 
    toc: yes
bibliography: 
  - index.bib
  - ../refs.bib
---

```{r, eval=FALSE, echo=FALSE}
citr::tidy_bib_file("~/uaf/allrefs.bib", rmd_file = "code/index.Rmd", file = "code/index.bib")
```

```{r setup, include=FALSE}
knitr::opts_knit$set(root.dir = "..")
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
```

```{r pkg, include=FALSE}
library(sf)
library(tidyverse)
library(tmap)
tmap_mode("view")
```

```{r, eval=FALSE}
# test build works before running for all:
source("code/build.R")
```

```{r bibs, engine='bash', eval=FALSE}
bibtool
ls *.bib
bibtool refs.bib report-refs.bib code/index.bib > refs.bib
```


# Introduction

The [rapid cycleway prioritisation tool](https://www.cyipt.bike/rapid/) helps identify promising locations for road space reallocation in England to create new cycleways.
Used with local knowledge, it provides an evidence base to support planning of rapid measures to support safe travel as part of the COVID-19 response.
The rational for the tool is that, in the context of COVID-19, big decisions need to be made quickly.
The tool aims to support fast yet informed decision making, by providing a 'first pass' assessment of the existing road network to help focus planning attention on options that are likely to have sufficient space for new infrastructure in places where there is high latent demand.

The rapid cycleway prioritisation tool aims to help produce evidence-based answers the question: **where to reallocate road space on strategic corridors to enable uptake of cycling?**
The focus of the tool is road space reallocation on strategic corridors, a key way in which transport systems can be transformed to overcome capacity constraints on public transport modes and prevent gridlock as the lockdown eases.

Reallocating road space on strategic corridors is just one of the measures available for transport authorities.
Evidence provided by the tool can also support a range of temporary, experimental and permanent treatments that will enable rapid and safe uptake of cycling.
New [statutory guidance on network management in response to COVID-19](https://www.gov.uk/government/publications/reallocating-road-space-in-response-to-covid-19-statutory-guidance-for-local-authorities/traffic-management-act-2004-network-management-in-response-to-covid-19) outlines a range of measures, including the creation of new cycleways, reducing speed limits, widening of footways and closing roads to motor traffic via 'modal filters'.
Road space reallocation is suited to larger roads and can have a large impact quickly, especially where moving large numbers of people away from public transport and capacity is a priority.
Furthermore, low but gradually increasing levels of peak hour motor traffic mean that there is a window of opportunity to reallocate lanes without causing congestion in the short term. 

<!-- # Input data -->

The tool identifies roads that have 'spare space', defined as roads with a spare lane or a width greater than 10 metres and high cycling potential, based on scenarios of mode shift to cycling for work and school in the [Propensity to Cycle Tool](https://www.pct.bike/).
The 10 m width is an indicator of where it may be possible to introduce new light segregation, depending on levels of on street parking and other factors, without altering the navigable network for motor vehicles.
On roads that are around 10 m wide or less, not highlighted by the tool, other interventions may be appropriate.
Options include 'modal filters' which prevent through traffic for motor vehicles, making roads one way for motor traffic (as implemented successfully with an Experimental Traffic Regulation Order in [Torrington Place](https://www.camden.gov.uk/torrington-tavistock-consultation), London, for example) or removing [central markings](https://doi.org/10.1016/j.aap.2014.08.015) [@shackel_influence_2014] may be required.^[
The road width required for new cycleways depends on a range of factors including the presence of on street parking. 
When on street parking is not an issue new cycleways supported by light segregation measures may be possible on narrower roads, as illustrated by the new trial cycleway on [South Road in Lancaster](https://www.facebook.com/photo/?fbid=10158393513440797&set=gm.1409892779205719&__cft__[0]=AZWl60wQjK9GqKMN_1t25YvwumbO3srWVvigT0H8NpP6n_8oaqPUKCLOW-u5ubg7Lg4agxSS7qNwVzEDCsBZYegxRVBGgHky-AkNLR-DJYyytsJpvi16VVEG8aofuaq9-S1ajmZA24d922GG8aapZ1LWv1dJ6N5ROym1TVK9rdB7mQ&__tn__=EH-R), which involved re-allocating carraigeway space on both sides of a ~9 m wide two way road using plastic wands.
A photo of this intervention can be seen [here](https://raw.githubusercontent.com/cyipt/popupCycleways/master/figures/lancashire-lane.jpeg).
]
Which roads to prioritise for road space reallocation and the most effective designs will also depend on factors such as on street parking levels, safety considerations and symbolic and aesthetic considerations not present in the analysis.

The cycling potential of each road is based on the Government Target (equality) scenario from the Propensity to Cycle Tool. 
The figures given represent the numbers of one way cycle trips to work and school that could be expected on each road, in a scenario where the [ Government’s aim of an overall doubling of cycling trips has been met](https://www.gov.uk/government/publications/cycling-and-walking-investment-strategy).
Our figures include data on travel to work from 2011 Census data and travel to school, assuming cycling grows evenly nationwide accounting for distance and hilliness [@lovelace_propensity_2017; @goodman_scenarios_2019]
Data on road widths and number of lanes is derived from the Cycling Infrastructure Prioritisation Toolkit (see [cyipt.bike](https://www.cyipt.bike/)).

# How to use the tool

To use the evidence generated for this project:

- Type in the name of the authority of interest into the search bar above the table below and click on the associated URL.
- Explore the results in the map (you will find a link to a full screen map) by panning, zooming and clicking on the layers. See additional layers by clicking on the layers icon in the top left of the map.
- Rank the 'top roads' in various ways (including by length and cycling potential) in the table below, to explore options highlighted by the tool to help prioritise road space reallocation schemes.
- Interpret the results with care based on other sources of information and an understanding of the limitations of the analysis (see 'Known issues and limitations' below).
- Refer to the description of the map layers below when exploring the results.

# Map layers

The maps contain five layers (two of which are hidden by default) that provide the results of our analysis, overlaying the basemaps. 
Clicking on the lines on the map for any of these layers will reveal a pop-up box containing more information about the road or segment of interest.

The three main layers are arranged in order of planning timescales:

1. The **Existing cycleways** layer provides an approximation of where cycling infrastructure exists **currently** (based on OpenStreetMap data downloaded in May 2020) and is intended to help identify gaps in the network that could be filled with new interventions.
2. The **Top ranked new cycleways** layer is the central result of the analysis, providing a list of roads that have high cycling potential, a minimum threshold length, and spare space according to our definition. These may be strong candidates for reallocation of road space **immediately or in the near future** to create new cycleways on strategic corridors under the Emergency Active Travel Fund.
3. The **Cohesive network** layer is intended to show what a joined-up cycle network could look like if we were to consider using a wider range of interventions to design new cycleways, such as closing roads to motorised traffic or creating one-way systems. Composed of roads that have high cycling potential on some or all of their length, the layer is designed to guide **long term planning**, alongside pre-existing plans such LCWIPs [@departmentfortransport_cycling_2017], towards a continuous and coherent network.

These main layers, and two other layers that informed the results but which are not shown by default, are described in detail below.

## 1. Existing cycleways

On the basis that plans should build on and extend existing provision, this layer shows existing cycleways.
This may be helpful to view in connection with the other layers, because it can reveal where gaps in the existing cycle network could be filled by new infrastructure.
<!-- This layer does not include some on-road cycle lanes or cycleways less than 500m in length, but these can be viewed in one of the basemap options (see below for more information about the basemaps). -->
The definition of ‘cycleway’ for the purpose of this layer includes shared use paths but excludes cycle lanes painted on roads.
The quality of the cycle paths is not reported in the data and the presence of a cycleway cannot guarantee that there is adequate provision, because some cycleways included in this dataset are of poor quality and/or are on paths shared by pedestrians that have limited capacity for high cycle traffic while observing physical distancing guidelines.
Also, because of the variable time lag between new cycleways being built and their appearance on OSM, not all existing cycleways are included in this layer (although most established cycleways in most areas are).
The data was accessed from OpenStreetMap in May 2020 so is up-to-date in many areas.

## 2. Top ranked new cycleways

These are the 'top n' road sections in terms of cycling potential with 'spare space' as defined above.
They may be suitable candidates for road space reallocation to create new cycleways. 
These roads have either a spare lane or an average width greater than 10 m, and are ranked according to their mean cycling potential. 
<!-- For routes that are shorter than 1km in length, we use 'km_cycled' instead of mean cycling potential - this is simply the mean cycling potential multiplied by the length of the route.  -->
Top ranked new cycleways are listed in the table below the map, so you can see more information on them. 
The number of Top ranked new cycleways varies depending on the size of the region.

We used the following criteria for the Top ranked new cycleways: 

- A road which already has an existing cycleway alongside the majority of its length cannot be a top route.
- Unnamed roads cannot be a top route.
- Routes less than 500m in length cannot be a top route.

Some road sections highlighted by the tool may not currently be suitable for new cycleways.
Road sections that are on strategic and major road networks (SRN and MRN respectively) and which had a high speed limit (40 mph+) before the COVID-19 crisis can be in the top routes.
To highlight such roads, the speed limits of road sections are listed in the table of the top ranked new cycleway locations to inform prioritisation and speed reduction interventions.

## 3. Cohesive network

This layer represents what a joined-up cycle network could look like if new cycleways were placed along corridors of high potential, by either closing roads to motorised traffic or creating one-way systems.
It shows what a joined-up cycle network could look like if there were no constraints on road space, along some of the most important corridors.

The cohesive network layer supports consideration of **long term** plans and alternatives to road space reallocation.
Road sections in the cohesive network but not in the Top ranked new cycleway layer may be suitable candidates for one way streets, where there may be insufficient space for road space reallocation without changing the navigable network for motor traffic.
The cohesive network layer was created to highlight the need for cohesive cycle network that and do not 'give up' at awkward junctions.
Cohesive networks are a key to getting people cycling [@buehler_bikeway_2016].

The layer was generated by first identifying the roads (classified by reference number) on which there is most cycling potential across the city and joining them together.
Specifically we first selected all road segments with cycle potential in the 85th percentile and above, which also belong to classified trunk roads, A roads or B roads.
These segments are then joined together to form a continuous network.

## 4. Spare lane(s) (not shown by default)

These are routes that have more than one vehicle lane in either direction and have a cycling potential above the minimum threshold (which varies according to region as it needs to be higher in e.g. Greater London than in rural areas).
This layer can be used to identify where there may be spare lanes on the network that could be reallocated to cycling (or pedestrianisation) beyond those highlighted in the Top ranked new cycleways layer.

## 5. Width >= 10m (not shown by default)

These routes are at least 10m in width and have a cycling potential above the minimum threshold. 
Like the Spare lane(s) layer, this layer is intended to highlight road sections on which increasing space for cycling and walking by reallocating road space may be a viable option.

# Basemaps

There are also five basemaps to choose from. The default basemap is grey and provides an uncluttered view. 
The second basemap option is a thematic map which shows all existing cycleways, including on-road cycle lanes. 
We then have two basemap options showing cycling potential for travel to work and travel to school from the Propensity to Cycle Tool. 
This allows our results to be compared with cycling potentials across the wider road network. 
These both follow the Government Target scenario; this is the same scenario as is used to derive the map layers described above. 
Finally, a satellite image is also available as a basemap.


# Known issues and limitations

<!-- We have developed this evidence base rapidly and -->

- The 'Top ranked new cycleways' highlighted in the map-based results were produced automatically based on a simple score combined cycling potential for school and commute trips.  **The results should be interpreted based on local knowledge and an understanding of the limitations of the data. The results are designed to complement not replace other factors such as feedback from the local community and long-term strategic cycle network plans.**
- The estimates of cycling potential only include school and work travel. Accounting for increases in cycling for other trip purposes such as for shopping and leisure would increase cycling potential substantially.
- The road network data was taken from the Cycling Infrastructure Prioritisation Toolkit (CyIPT) project which was completed in 2017, so may be out of date.
- The results are based on the existing road network. They do not flag potential routes that could be constructed, e.g. along old railway tracks or across open areas.
- The results can highlight major roads that have a speed limit above 40mph that may currently be unsuitable for new cycleways created with light segregation. Roads not controlled by local authorities on the SRN can also be highlighted (although motorways are excluded); we do not alter the results based on who is in control of the roads.
- Other than the Cohesive network layer, which highlights what a joined-up cycle network could look like if roads could be made one way to motor traffic and opened-up to cycling via modal filters, the results do not provide evidence on the full range of interventions. Identifying locations for filtered permeability interventions in residential areas, for example, requires data on residential networks not contained in this analysis.

<!-- Like many projects that have been initiated in response to COVID-19 we have developed the analy -->

If you are interested in the code underlying the project and would like to support the project with technical input, please provide feedback via the [GitHub issue tracker (requires a GitHub account)](https://github.com/cyipt/popupCycleways/issues).


```{r}
regions = readRDS("regions_dft.Rds")
regions_centroids = sf::st_point_on_surface(regions)
regions$html_name = tolower(gsub(pattern = " |, ", replacement = "-", regions$Name))
regions$url = paste0("<a href='", regions$html_name ,"' target='_blank'>", regions$Name, "</a>")
```

```{r}
pvars = c("Name", "Level")
tm_shape(regions) + tm_polygons("Level", popup.vars = pvars) 
  # + tm_shape(regions_centroids) + tm_text("Name", size = 0.7)
```

```{r}
dn = "popupCycleways/v1" # dirctory name
built_regions = list.files(dn)
regions = regions %>% 
  filter(stringr::str_detect(string = Name, "Scilly", negate = TRUE))
regions %>%
  sf::st_drop_geometry() %>%
  # filter(html_name %in% built_regions) %>% 
  select(Name, Level, url) %>% 
  arrange(Name) %>% 
  DT::datatable(escape = -4)
```

```{r, eval=FALSE}
dir.create(dn)
region_names_to_build = regions$Name
# region_names_to_build = regions$Name[!regions$html_name %in% built_regions]
sample_to_build_regex = "west of|west y|west mid|hereford|nott|leic|manc|liv|cam|bright|suff"
region_names_to_build = regions %>%
  filter(grepl(pattern = sample_to_build_regex, x = Name, ignore.case = TRUE)) %>%
  pull(Name)
# region_names_to_build = c("West Yorkshire", "Nottingham")
# region_names_to_build = c("Greater London", "Cambridgeshire")
regions_within_names = c("Leicester", "Nottingham", "Derby", "Stoke-on-Trent")
names(regions_within_names) = c(paste0(regions_within_names[1:3], "shire"), "Staffordshire")
regions_containing_names = names(regions_within_names)
names(regions_containing_names) = regions_within_names

rn = "West of England"
for(rn in region_names_to_build) {
  region = regions %>% filter(Name == rn)
  if(rn %in% c(regions_within_names)) {
    region$geometry = sf::st_union(
      region,
      regions %>% filter(Name == regions_containing_names[rn])
      ) %>% sf::st_geometry()
  }
  t = Sys.time()
  message("Building for ", rn)
  d = file.path(dn, region$html_name)
  dir.create(d)
  region_name = region$Name
  # source("code/build.R")
  rmarkdown::render(input = "code/build.R", output_dir = d, knit_root_dir = ".")
  plot(sf::st_geometry(r_lanes_top))
  htmlwidgets::saveWidget(m_leaflet, file.path("~/cyipt/tempCycleways/", d, "m.html"))
  time_to_run = Sys.time() - t
  rmarkdown::render("code/region_index.Rmd", output_file = file.path("~/cyipt/tempCycleways/", d, "index.html"))
  sf::write_sf(cycleways, file.path(d, "cycleways.geojson"))
  sf::write_sf(top_routes, file.path(d, "top_routes.geojson"))
  sf::write_sf(key_network_final, file.path(d, "cohesive_network.geojson"))
  sf::write_sf(spare_lanes_final, file.path(d, "spare_lanes.geojson"))
  sf::write_sf(wide_lanes_final, file.path(d, "wide_lanes.geojson"))
  message(round(time_to_run), " minutes to build ", rn)
}
rmarkdown::render("code/index.Rmd", output_dir = dn)
browseURL(file.path(dn, "index.html"))
```

```{r, eval=FALSE}
# rebuild results based on pre-processed data (wip)
for(rn in region_names_to_build) {
  region = regions %>% filter(Name == rn)
  if(rn %in% c(regions_within_names)) {
    region$geometry = sf::st_union(
      region,
      regions %>% filter(Name == regions_containing_names[rn])
      ) %>% sf::st_geometry()
  }
  t = Sys.time()
  message("Building for ", rn)
  d = file.path(dn, region$html_name)
  dir.create(d)
  region_name = region$Name
  # source("code/build.R")
  rmarkdown::render(input = "code/build.R", output_dir = d, knit_root_dir = ".")
  plot(sf::st_geometry(r_lanes_top))
  htmlwidgets::saveWidget(m_leaflet, file.path("~/cyipt/tempCycleways/", d, "m.html"))
  time_to_run = Sys.time() - t
  rmarkdown::render("code/region_index.Rmd", output_file = file.path("~/cyipt/tempCycleways/", d, "index.html"))
  fg = list.files(path = d, pattern = ".geojson", full.names = TRUE)
  file.remove(fg)
  sf::write_sf(cycleways, file.path(d, "cycleways.geojson"))
  sf::write_sf(top_routes, file.path(d, "top_routes.geojson"))
  sf::write_sf(key_network_final, file.path(d, "cohesive_network.geojson"))
  sf::write_sf(spare_lanes_final, file.path(d, "spare_lanes.geojson"))
  sf::write_sf(wide_lanes_final, file.path(d, "wide_lanes.geojson"))
  sf::write_sf(region, file.path(d, "region.geojson"))
  sf::write_sf(lads, file.path(d, "lads.geojson"))
  message(round(time_to_run), " minutes to build ", rn)
}
m =
  tm_shape(lads, name = "Local authority district boundaries") + tm_borders() +
  tm_shape(key_network_final, name = "Cohesive network") +
  tm_lines(lwd = 5, col = "darkgrey", popup.vars = pvars_key) +
  tm_shape(spare_lanes_final, name = labels[2]) +
  tm_lines(legend.col.show = FALSE,
           col = cols_status[2], 
           lwd = 3,
           alpha = 1,
           popup.vars = pvars_spare,
           group = labels[2]
           ) +
  tm_shape(wide_lanes_final, name = labels[2]) +
  tm_lines(legend.col.show = FALSE,
           col = cols_status[3], 
           lwd = 3,
           alpha = 1,
           popup.vars = pvars_spare,
           group = labels[3]
  ) +
  tm_shape(cycleways, name = cycleways_name) + tm_lines(popup.vars = c("surface", "name", "osm_id"), col = "darkgreen", lwd = 1.3) +
  tm_shape(top_routes, name = "Top routes") +
  tm_lines(legend.col.show = FALSE,
           col = cols_status[1], 
           lwd = 5,
           alpha = 1,
           popup.vars = popup.vars
  ) +
  tm_basemap(server = s, tms = tms) +
  tm_add_legend(type = "fill", labels = legend_labels[1:3], col = legend_colours[1:3]) +
  tm_add_legend(type = "fill", labels = labels[2], col = legend_colours[4], group = labels[2]) +
  tm_add_legend(type = "fill", labels = labels[3], col = legend_colours[5], group = labels[3]) +
  tm_scale_bar() 
# m
m_leaflet = tmap_leaflet(m) %>% leaflet::hideGroup(labels[2:3])
```


# References


