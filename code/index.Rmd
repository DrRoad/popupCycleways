---
title: "Rapid cycleway prioritisation tool"
author: "Dr Robin Lovelace & Dr Joey Talbot, Institute for Transport Studies, University of Leeds"
output: 
  html_document: 
    toc: yes
---

```{r setup, include=FALSE}
knitr::opts_knit$set(root.dir = "..")
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
```

```{r pkg, include=FALSE}
library(sf)
library(tidyverse)
library(tmap)
tmap_mode("view")
```

```{r, eval=FALSE}
# test build works before running for all:
source("code/build.R")
```

# NOTE: PRELIMINARY RESULTS

Not quality assured.

Please provide feedback on these preliminary results on this [web form (estimated time to complete: 5 minutes)](https://forms.office.com/Pages/ResponsePage.aspx?id=qO3qvR3IzkWGPlIypTW3y9orQ9urif9IgBaXiRS9eEpUM0JCTDRFTTEwSDRVMUs0VVhVWEdGRDA3RS4u).

# Introduction

This tool helps identify road sections for road space reallocation and other interventions to create new cycleways.
Used with local knowledge, it provides a strong evidence base to support planning of rapid measures to support safe travel as part of the COVID-19 response.
The evidence may be used to support a range of temporary, experimental and permanent treatments that will enable shift to walking and cycling in the coming weeks and months, to help overcome capacity constraints on public transport modes and prevent gridlock as the lockdown eases.

Maps are available for regions covering the whole of England. 

The focus is on roads that have 'spare space' (defined as those with a spare lane or that have an estimated width of above 10 m) and high cycling potential.
The 10 m width is an indicator of road conditions and larger widths, of 15+ m, may be required for road space reallocation without other changes such as making roads one way for motor traffic or removing central markings as described in a paper by Stella Shackel and John Parkin ([2014](https://doi.org/10.1016/j.aap.2014.08.015)).
Which roads to prioritise and the most effective interventions will also depend on factors such as on street parking levels not present in the analysis.

Reallocating roadspace is just one of the measures available for transport authorities.
Other approaches include modal filters, road closures, and the creation of bus, walking and cycling only streets, as well as speed limits and traffic calming measures. Used strategically, a combination of these measures can promote active travel through the creation of filtered permeability networks and Low Traffic Neighbourhoods.
For certain types of area, such as residential zones, this may be the most suitable approach.
However, roadspace reallocation is naturally suited to larger arterial-type roads and that is the focus of this tool.

The cycling potential of each road is based on data from the Propensity to Cycle Tool (see [www.pct.bike](https://www.pct.bike/) for further details) and represents the number of one way cycle trips to work and school that could be expected when the [Government's aim of doubling cycling is met](https://www.gov.uk/government/publications/cycling-and-walking-investment-strategy).
The scenario assumes cycling grows evenly nationwide accounting for distance and hilliness.
Our figures include data on travel to work from 2011 Census data and travel to school. Data on road widths and number of lanes is derived from the Cycling Infrastructure Prioritisation Toolkit.

Overall the evidence presented in the tool is designed to encourage bold interventions where more space for active modes is most needed.
The work is based evidence that road space can be reallocated without causing congestion at a time when traffic levels, particularly during the rush hours, are greatly reduced.

# How to use the tool

To use the evidence generated for this project:

- Type in the name of the local authority of interest into the search bar above the table below and click on the associated URL.
- Explore the results in the map (you will find a link to a full screen map) by panning, zooming and clicking on the layers. See additional layers by clicking on the layers icon in the top left of the map.
- Rank the 'top roads' in various ways (including by length and cycling potential) to support prioritisation of road space reallocation schemes.
- Interpret the results with care based on other sources of information and an understanding of the limitations of the analysis (see 'Known issues and limitations' below).
- Refer to the description of the map layers below when exploring the results and complete the [web form](https://urldefense.proofpoint.com/v2/url?u=https-3A__forms.office.com_Pages_ResponsePage.aspx-3Fid-3DqO3qvR3IzkWGPlIypTW3y9orQ9urif9IgBaXiRS9eEpUM0JCTDRFTTEwSDRVMUs0VVhVWEdGRDA3RS4u&d=DwMCaQ&c=troKkvwivNn_CddsvWCHHPiPoFoTgTGIbXJULvYU158&r=DXeEYtdSYDBZN2DBwEgAHMmX5PQ_ob9r2MynFWta2mU&m=mkyUa3RIC9d5LSrHUqk_WdstQR1OQuTWyYLBecHFMm0&s=dD7GVcQbjZ2AcdCObSe-rNKmLLDBhu98ChFupIIrlJA&e=) with any feedback.

# Map layers

The maps contain five layers of data that overlay the basemaps. 

Click on any of these layers to see a pop-up box containing more information about the road in question.

## 1. Cohesive network

This layer is designed to represent a cohesive network of direct routes.
It shows what a joined-up cycle network could look like if there were no constraints on road space, along some of the most important corridors.
The layer takes no account spare space and is designed to support consideratioin of alternative options, e.g. one way streets, where there may be insufficient space for road space reallocation without changing the navigable network for motor traffic.
The layer was developed based on evidence on the importance of active transport network that are continuous and do not 'give up' at awkward junctions.
The layer was created by selecting all road segments with cycle potential in the 85th percentile and above, which also belong to classified trunk roads, A roads or B roads.
These segments are then joined together to form a continuous network.

## 2. Existing cycleways

This layer shows existing cycleways. This may be helpful to view in connection with the other layers, because it can reveal where gaps in the existing cycle network could be filled by new infrastructure. This layer does not include some on-road cycle lanes or cycleways less than 500m in length, but these can be viewed in one of the basemap options (see below for more information about the basemaps).

The following three layers are the central results of our analysis, representing the most promising locations for pop-up cycleways.

## 3. Top routes

These are the top routes for pop-up cycleways according to our analysis. 
These roads have either a spare lane or width of at least 10m, and are ranked according to their mean cycling potential. 
For routes that are shorter than 1km in length, we use 'km_cycled' instead of mean cycling potential - this is simply the mean cycling potential multiplied by the length of the route. 
Top routes are listed in the table below the map, so you can see more information on them. 
The number of top routes selected is normally 20, with some variation by region.

We used certain eligibility criteria for the top routes: 

- a road which already has an existing cycleway alongside the majority of its length cannot be a top route. 
- unnamed roads cannot be a top route 
- routes less than 500m in length cannot be a top route

## 3. Spare lane(s) (not shown by default)

These are routes that have more than one vehicle lane in either direction and have a cycling potential above the minimum threshold (which varies according to region as it needs to be higher in e.g. Greater London than in rural areas).

## 4. Width >= 10m (not shown by default)

These routes are at least 10m in width and have a cycling potential above the minimum threshold. 

# Basemaps

There are also seven basemaps to choose from. The default basemap is grey and provides an uncluttered view. We then have basemap options showing four different scenarios from the Propensity to Cycle Tool. This allows our results to be compared with cycling potentials across the road network. The scenarios available show cycling potential for Commuting (government target), Schools (government targets), Commuting (e-bikes), and schools (Go Dutch).

A further basemap option shows all existing cycleways, including on-road cycle lanes. Finally, a satellite image is also available as a basemap.


# Known issues and limitations

<!-- We have developed this evidence base rapidly and -->

- The 'top routes' highlighted in the map-based results were produced automatically based on a simple score of continuous candidate road length multiplied by cycling potential. For roads with a length of more than 1 km, the cycling potential alone is used to rank roads. **The results should be interpreted based on local knowledge and an understanding of the limitations of the data. The results are designed to complement not replace other factors such as feedback from the local community and long-term strategic cycle network plans.**
- The estimates of cycling potential only include school and work travel. Accounting for increases in cycling for other trip purposes such as for shopping and leisure would increase cycling potential substantially.
- The results rely on grouping roads by proximity, name and other variables. Currently some roads that are strong candidates for new cycleways may be missing from the results because of how the algorithm works (we are working on this issue).
- The road network data was taken from the Cycling Infrastructure Prioritisation Toolkit (CyIPT) project which was completed in 2017, so may be out of date (we are looking at ways to update the data).
- The results are based on the existing road network and does not flag potential routes that could be constructed.

<!-- Like many projects that have been initiated in response to COVID-19 we have developed the analy -->

If you find any other issues with the results or have suggestions of ways to improve the results, please provide feedback on the [web form](https://forms.office.com/Pages/ResponsePage.aspx?id=qO3qvR3IzkWGPlIypTW3y9orQ9urif9IgBaXiRS9eEpUM0JCTDRFTTEwSDRVMUs0VVhVWEdGRDA3RS4u).
If you are interested in the code underlying the project and would like to support the project with technical input, please provide feedback via the [GitHub issue tracker (requires a GitHub account)](https://github.com/cyipt/popupCycleways/issues).


```{r}
regions = readRDS("regions_dft.Rds")
regions_centroids = sf::st_point_on_surface(regions)
regions$html_name = tolower(gsub(pattern = " |, ", replacement = "-", regions$Name))
regions$url = paste0("<a href='", regions$html_name ,"' target='_blank'>", regions$Name, "</a>")
```

```{r}
pvars = c("Name", "Level")
tm_shape(regions) + tm_polygons("Level", popup.vars = pvars) 
  # + tm_shape(regions_centroids) + tm_text("Name", size = 0.7)
```

```{r}
dn = "popupCycleways/v0.3" # dirctory name
built_regions = list.files(dn)
regions = regions %>% 
  filter(stringr::str_detect(string = Name, "Scilly", negate = TRUE))
regions %>%
  sf::st_drop_geometry() %>%
  filter(html_name %in% built_regions) %>% 
  select(Name, Level, url) %>% 
  arrange(Name) %>% 
  DT::datatable(escape = -4)
```

```{r, eval=FALSE}
dir.create(dn)
region_names_to_build = regions$Name
# region_names_to_build = regions$Name[!regions$html_name %in% built_regions]
# sample_to_build_regex = "west of|west y|west mid|hereford|nott|leic|manc|liv|cam"
# region_names_to_build = regions %>% 
#   filter(grepl(pattern = sample_to_build_regex, x = Name, ignore.case = TRUE)) %>% 
#   pull(Name)
# region_names_to_build = c("West Yorkshire", "Nottingham")
# region_names_to_build = c("Greater London", "Cambridgeshire")
regions_within_names = c("Leicester", "Nottingham", "Derby", "Stoke-on-Trent")
names(regions_within_names) = c(paste0(regions_within_names[1:3], "shire"), "Staffordshire")
regions_containing_names = names(regions_within_names)
names(regions_containing_names) = regions_within_names

rn = "West of England"
for(rn in region_names_to_build[50:nrow(regions)]) {
  region = regions %>% filter(Name == rn)
  if(rn %in% c(regions_within_names)) {
    region$geometry = sf::st_union(
      region,
      regions %>% filter(Name == regions_containing_names[rn])
      ) %>% sf::st_geometry()
  }
  t = Sys.time()
  message("Building for ", rn)
  d = file.path(dn, region$html_name)
  dir.create(d)
  region_name = region$Name
  # source("code/build.R")
  rmarkdown::render(input = "code/build.R", output_dir = d, knit_root_dir = ".")
  plot(sf::st_geometry(r_lanes_top))
  htmlwidgets::saveWidget(m_leaflet, file.path("~/cyipt/tempCycleways/", d, "m.html"))
  time_to_run = Sys.time() - t
  rmarkdown::render("code/region_index.Rmd", output_file = file.path("~/cyipt/tempCycleways/", d, "index.html"))
  message(round(time_to_run), " minutes to build ", rn)
}
rmarkdown::render("code/index.Rmd", output_dir = dn)
browseURL(file.path(dn, "index.html"))
```




