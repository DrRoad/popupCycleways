---
title: "Rapid Cycleway Prioritisation Tool"
author: "Dr Robin Lovelace & Dr Joey Talbot, Institute for Transport Studies, University of Leeds"
output: 
  html_document: 
    toc: yes
bibliography: 
  - index.bib
  - ../refs.bib
---

```{r, eval=FALSE, echo=FALSE}
citr::tidy_bib_file("~/uaf/allrefs.bib", rmd_file = "code/index.Rmd", file = "code/index.bib")
```

```{r setup, include=FALSE}
knitr::opts_knit$set(root.dir = "..")
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
```

```{r pkg, include=FALSE}
library(sf)
library(tidyverse)
library(dplyr)
library(tmap)
tmap_mode("view")
```

```{r, eval=FALSE}
# test build works before running for all:
source("code/build.R")
```

```{r bibs, engine='bash', eval=FALSE}
bibtool
ls *.bib
bibtool refs.bib report-refs.bib code/index.bib > refs.bib
```


# Introduction

[Sustrans](https://www.sustrans.org.uk/) and the [Department for Transport](https://www.gov.uk/government/organisations/department-for-transport) commissioned ITS Leeds to develop the [Rapid Cycleway Prioritisation Tool](https://www.cyipt.bike/rapid/) to help identifying promising locations for new cycleways in England.
The immediate purpose of this project is to inform bids for Tranche 2 of the [Emergency Active Travel Fund](https://www.gov.uk/government/publications/emergency-active-travel-fund-local-transport-authority-allocations), particularly for authorities which have not yet developed Local Cycling and Walking Investment Plans ([LCWIP](https://www.gov.uk/government/publications/local-cycling-and-walking-infrastructure-plans-technical-guidance-and-tools)). 
Tranche 2 will fund temporary or permanent infrastructure schemes aimed at increasing active travel and helping to shift people away from public transport given capacity constraints imposed by social distancing.

For each combined and local authority, the tool identifies existing cycleways, promising locations for new cycleways on roads with spare space ('top ranked new cycleways') and what a cohesive cycling network might look like in the longer-term.

# How does the tool identify 'top ranked new cycleways'?

The tool identifies priority locations for new cycleways, ranking roads by their 'cycling potential' estimated using the Propensity to Cycle Tool ([PCT](https://www.pct.bike/)). This represents the estimated number of cycling trips along this road travelling to or from work or school assuming the Government's [aim](https://www.gov.uk/government/publications/cycling-and-walking-investment-strategy) to double cycling by 2025 is met.

The 'top ranked new cycleways' represents the roads with the highest cycling potential which also have spare space; that is, are either wide or have two or more road lanes in one direction.
We have restricted the analysis to focusing on roads with spare lanes since these have the capacity to accommodate new cycleways whilst maintaining two-way traffic.
New cycleways on these routes may therefore be faster to deliver than those requiring roads to be closed to traffic or introducing one-way systems.
In addition, these are likely to represent the key arterial routes into town and city centres; hence new cycleways on these roads could result in large increases in cycling volumes.

# How does the tool identify what a 'cohesive network' might look like?

The tool also identifies what a 'cohesive network' for cycling might look like if we were to consider a wider range of interventions such as closing roads to motorised traffic and creating one-way systems. This has been estimated by joining up roads that have a high cycling potential on some or all their length. The 'cohesive network' might help authorities considering area-wide interventions such as pedestrian and cycle zones or modal filters.

# How can I find the results for my area?

Results for each combined and local authorities can be accessed by clicking on the relevant area from the map below or search the authority's name from the list below.
This opens a separate webpage presenting a map of the areas identifying 'existing cycleways', 'top ranked new cycleways' and the 'cohesive network'.
It also presents a table providing various data about the top ranked new cycleways including the cycling potential, length of continuous cycle network (including the existing network), current speed limit and whether the road is wide and/or has spare road lanes.

# How should I use these results?

Authorities may wish to use results from the tool to help prioritise their bids for Tranche 2 of the Emergency Active Travel Fund, complementing local knowledge and stakeholder engagement.

For example, authorities considering new cycleways may want to review the 'top ranked new cycleways' to inform their decision where best to invest. The table below the maps allows users to rank potential new cycleways by various metrics including: 

- cycling potential (default metric to rank schemes)
- total length of cycling infrastructure created
- cycling potential x infrastructure length

In addition, the table provides information about road speed limits, width and road lanes which might help users filter out locations which are less desirable for them.
For example:

- Trunk roads with speed limits of 40mph or over may be less suitable for cycleways given their strategic importance for heavy goods vehicles or potentially due to safety concerns for cyclists (particularly for temporary cycleways).
- Authorities may wish to prioritise new cycleways on wide roads rather than reallocating road lanes from motorists to cyclists.

Additionally, authorities considering area-wide measures may wish to consider the data for the 'cohesive network'. Currently the tool cannot identify specific interventions to promote cycling (e.g. such as pedestrian and cycle zones or modal filters); however, it should give an indication of where such measures might add greatest value.

# What are the key limitations of the tool?


- Currently the tool has been developed primarily to help authorities prioritise the best locations for new cycleways. While it provides some indication of what a cohesive network might look like, it doesn't seek to prioritise what is the best type of intervention for a given location.
- The ranking of cycleways may not represent a proxy for which schemes are likely to deliver the best value for money. As a consequence this tool doesn't remove the need to use the Department for Transport's Active Mode Appraisal Toolkit ([AMAT](https://www.gov.uk/government/publications/tag-social-and-distributional-impacts-worksheets)) to assess whether proposed schemes deliver value for money.
- The best locations for new cycleways may not always be on roads with spare lanes. For example, in some circumstances it may be preferable for new cycleways to be along quiet roads running parallel to major arterial routes.
- The results for the 'top ranked new cycleways' doesn't identify routes under 500m with multiple changes of road name and doesn't identify short routes (under 500m) linking up existing cycleways. To address this limitation, the tool includes results labelled 'spare lane(s)' and 'estimated width >10m' which plug these gaps. These layers are hidden by default but can be found by clicking the 'layer' button in the top left corner of the map.
- The road network data is from 2017 and so will be slightly out-of-date.
- The model estimates the cycling potential of roads based on the estimated number of trips to and from work and school. Currently it is not possible to estimate cycling potential accounting for all journey purposes including shopping and leisure trips, which would significantly increase the estimated cycling potential.
- The PCT uses data from the 2011 Census and 2011 Cycle to School Census to estimate cycling potential. Hence the estimated cycling potential may represent an underestimate if there has been significant construction active in the area since 2011.
- The tool currently only identifies priority on-road routes for new cycleways. There may also be desirable off-road locations for new cycleways including alongside old railway lines or across open areas.
- Currently the tool allows for new cycleways on trunk roads with speeds of 40mph or more. While in some limited cases this may be desirable (e.g. where trunk roads are causing significant air pollution), in many cases it may not be desirable to reallocate road space from trunk roads to new cycleways. To address this, we have identify which top ranked routes have speed limits of 40mph or more in the tables.

# Where can I find further information about the tool?

The technical specification for the Rapid Cycleway Prioritisation Tool can be found [here](https://github.com/cyipt/popupCycleways/releases/download/0.3/report.pdf), providing further detail about the assumptions underlying the tool.

A webinar about the Rapid Cycleway Prioritisation Tool is being held on 17th June 2020 from 10:30-11:45.
Sign-up details can be found [here](https://register.gotowebinar.com/register/3517000554526190862?source=dft) and recording of the webinar will be available on the website after the event.

Data about the tools informing the model can be found here:

- The [Propensity to Cycle Tool](https://www.pct.bike/)
- The [Cycling Infrastructure Prioritisation Tool](https://www.cyipt.bike)
- [OpenStreetMap](https://www.openstreetmap.org/#map=7/52.486/-2.428&layers=C)

For expert users, the code underlying the project can be accessed [here](https://github.com/cyipt/popupCycleways).
If you would like to support the project with technical input, please provide feedback via the [GitHub issue tracker](https://github.com/cyipt/popupCycleways/issues/14).
Data generated by the project can be downloaded from GitHub (e.g. see GeoJSON files for London [here](https://github.com/cyipt/popupCycleways/tree/gh-pages/release/greater-london)).











The results from this project have been delivered rapidly and should be used alongside local knowledge and stakeholder engagement.

The tool provides an evidence base to support investment in cycling infrastructure, in response to new pressures placed on transport and public health systems by the COVID-19 crisis, at local and regional levels.
The rational for the tool is that, in the context of COVID-19, big decisions around where to prioritise investment on the road network need to be made quickly.
The tool provides a 'first pass' assessment of promising locations for new cycleways which have high latent demand for cycling and where road space can be reallocated whilst maintaining two-way traffic flows for motorists.

The Rapid Cycleway Prioritisation Tool aims to help produce evidence-based answers the question: **where to reallocate road space on strategic corridors to enable uptake of cycling?**
The focus of the tool is road space reallocation on strategic corridors, a key way in which transport systems can be transformed to overcome capacity constraints on public transport modes and prevent gridlock during the phased 'restart'.

Reallocating road space on strategic corridors is just one of the measures available for transport authorities.
Evidence provided by the tool can also support a range of temporary, experimental and permanent treatments that will enable rapid and safe uptake of cycling.
New [statutory guidance on network management in response to COVID-19](https://www.gov.uk/government/publications/reallocating-road-space-in-response-to-covid-19-statutory-guidance-for-local-authorities/traffic-management-act-2004-network-management-in-response-to-covid-19) outlines a range of measures, including the creation of new cycleways, reducing speed limits, widening of footways and closing roads to motor traffic via 'modal filters'.
Road space reallocation is suited to larger roads and can have a large impact quickly, especially where moving large numbers of people away from public transport and capacity is a priority.
Furthermore, low but gradually increasing levels of peak hour motor traffic mean that there is a window of opportunity to reallocate lanes without causing congestion in the short term. 

<!-- # Input data -->

The tool identifies roads that have 'spare space', defined as roads with a spare lane or a width greater than 10 metres and high cycling potential, based on scenarios of mode shift to cycling for work and school in the [Propensity to Cycle Tool](https://www.pct.bike/).
The 10 m width is an indicator of where it may be possible to introduce new light segregation, depending on levels of on street parking and other factors, without altering the navigable network for motor vehicles.
On roads that are around 10 m wide or less, not highlighted by the tool, other interventions may be appropriate.
Options include 'modal filters' which prevent through traffic for motor vehicles, making roads one way for motor traffic (as implemented successfully with an Experimental Traffic Regulation Order in [Torrington Place](https://www.camden.gov.uk/torrington-tavistock-consultation), London, for example) or removing [central markings](https://doi.org/10.1016/j.aap.2014.08.015) [@shackel_influence_2014] may be required.^[
The road width required for new cycleways depends on a range of factors including the presence of on street parking. 
When on street parking is not an issue new cycleways supported by light segregation measures may be possible on narrower roads, as illustrated by the new trial cycleway on [South Road in Lancaster](https://www.facebook.com/photo/?fbid=10158393513440797&set=gm.1409892779205719&__cft__[0]=AZWl60wQjK9GqKMN_1t25YvwumbO3srWVvigT0H8NpP6n_8oaqPUKCLOW-u5ubg7Lg4agxSS7qNwVzEDCsBZYegxRVBGgHky-AkNLR-DJYyytsJpvi16VVEG8aofuaq9-S1ajmZA24d922GG8aapZ1LWv1dJ6N5ROym1TVK9rdB7mQ&__tn__=EH-R), which involved re-allocating carraigeway space on both sides of a ~9 m wide two way road using plastic wands.
A photo of this intervention can be seen [here](https://raw.githubusercontent.com/cyipt/popupCycleways/master/figures/lancashire-lane.jpeg).
]
Which roads to prioritise for road space reallocation and the most effective designs will also depend on factors such as on street parking levels, safety considerations and symbolic and aesthetic considerations not present in the analysis.

The cycling potential of each road is based on the Government Target (equality) scenario from the Propensity to Cycle Tool. 
The figures given represent the numbers of one way cycle trips to work and school that could be expected on each road, in a scenario where the [ Government's aim of an overall doubling of cycling trips has been met](https://www.gov.uk/government/publications/cycling-and-walking-investment-strategy).
Our figures include data on travel to work from 2011 Census data and travel to school, assuming cycling grows evenly nationwide accounting for distance and hilliness [@lovelace_propensity_2017; @goodman_scenarios_2019]
Data on road widths and number of lanes is derived from the Cycling Infrastructure Prioritisation Toolkit (see [cyipt.bike](https://www.cyipt.bike/)).

# How to use the tool

To use the evidence generated for this project:

- Type in the name of the authority of interest into the search bar above the table below and click on the associated URL.
- Explore the results in the map (you will find a link to a full screen map) by panning, zooming and clicking on the layers. See additional layers by clicking on the layers icon in the top left of the map.
- Rank the 'top roads' in various ways (including by length and cycling potential) in the table below, to explore options highlighted by the tool to help prioritise road space reallocation schemes.
- Interpret the results with care based on other sources of information and an understanding of the limitations of the analysis (see 'Known issues and limitations' below).
- Refer to the description of the map layers below when exploring the results.

# Map layers

The maps contain five layers (two of which are hidden by default) that provide the results of our analysis, overlaying the basemaps. 
Clicking on the lines on the map for any of these layers will reveal a pop-up box containing more information about the road or segment of interest.

The three main layers are arranged in order of planning timescales:

1. The **Existing cycleways** layer provides an approximation of where cycling infrastructure exists **currently** (based on OpenStreetMap data downloaded in May 2020) and is intended to help identify gaps in the network that could be filled with new interventions.
2. The **Top ranked new cycleways** layer is the central result of the analysis, providing a list of roads that have high cycling potential, a minimum threshold length, and spare space according to our definition. These may be strong candidates for reallocation of road space **immediately or in the near future** to create new cycleways on strategic corridors under the Emergency Active Travel Fund.
3. The **Cohesive network** layer is intended to show what a joined-up cycle network could look like if we were to consider using a wider range of interventions to design new cycleways, such as closing roads to motorised traffic or creating one-way systems. Composed of roads that have high cycling potential on some or all of their length, the layer is designed to guide **long term planning**, alongside pre-existing plans such LCWIPs [@departmentfortransport_cycling_2017], towards a continuous and coherent network.

These main layers, and two other layers that informed the results but which are not shown by default, are described in detail below.

## 1. Existing cycleways

On the basis that plans should build on and extend existing provision, this layer shows existing cycleways.
This may be helpful to view in connection with the other layers, because it can reveal where gaps in the existing cycle network could be filled by new infrastructure.
<!-- This layer does not include some on-road cycle lanes or cycleways less than 500m in length, but these can be viewed in one of the basemap options (see below for more information about the basemaps). -->
The definition of 'cycleway' for the purpose of this layer includes shared use paths but excludes cycle lanes painted on roads.
The quality of the cycle paths is not reported in the data and the presence of a cycleway cannot guarantee that there is adequate provision, because some cycleways included in this dataset are of poor quality and/or are on paths shared by pedestrians that have limited capacity for high cycle traffic while observing physical distancing guidelines.
Also, because of the variable time lag between new cycleways being built and their appearance on OSM, not all existing cycleways are included in this layer (although most established cycleways in most areas are).
The data was accessed from OpenStreetMap in May 2020 so is up-to-date in many areas.

## 2. Top ranked new cycleways

These are the 'top n' road sections in terms of cycling potential with 'spare space' as defined above.
They may be suitable candidates for road space reallocation to create new cycleways. 
These roads have either a spare lane or an average width greater than 10 m, and are ranked according to their mean cycling potential. 
<!-- For routes that are shorter than 1km in length, we use 'km_cycled' instead of mean cycling potential - this is simply the mean cycling potential multiplied by the length of the route.  -->
Top ranked new cycleways are listed in the table below the map, so you can see more information on them. 
The number of Top ranked new cycleways varies depending on the size of the region.

We used the following criteria for the Top ranked new cycleways: 

- A road which already has an existing cycleway alongside the majority of its length cannot be a top route.
- Unnamed roads cannot be a top route.
- Routes less than 500m in length cannot be a top route.

Some road sections highlighted by the tool may not currently be suitable for new cycleways.
Road sections that are on strategic and major road networks (SRN and MRN respectively) and which had a high speed limit (40 mph+) before the COVID-19 crisis can be in the top routes.
To highlight such roads, the speed limits of road sections are listed in the table of the top ranked new cycleway locations to inform prioritisation and speed reduction interventions.

## 3. Cohesive network

This layer represents what a joined-up cycle network could look like if new cycleways were placed along the key corridors of high potential. 
Unlike the 'top ranked new cycleways' layer, the cohesive network comprises all of the major high cycle potential corridors, including sections where the roads are narrower. 
It shows what a joined-up cycle network could look like if there were no constraints on road space, along some of the most important corridors.

The cohesive network layer includes sections where there may be insufficient space for road space reallocation without changing the navigable network for motor traffic.
It was created to highlight the need for a cohesive cycle network that does not 'give up' at awkward junctions.
Cohesive networks are a key to getting people cycling [@buehler_bikeway_2016].

This layer supports consideration of **long term** plans and alternatives to road space reallocation.
Some sections of the cohesive network may still be suitable candidates for road-space reallocation (for example, [in Lancaster](https://www.facebook.com/photo.php?fbid=10158393513440797&set=gm.1409892779205719&type=1&theater) protected cycle lanes have recently been installed on a road which is less than 10 m in width), but other sections may be best suited to different types of traffic measure, such as point closures, cycleway installation on a nearby parallel alignment, or conversion to one way streets in order to free up space for cycle lanes.

The layer was generated by identifying the roads (classified by reference number) on which there is greatest cycling potential across the region and joining them together.
Specifically we first selected all road segments with cycle potential in the 85th percentile and above, which also belong to classified trunk roads, A roads or B roads.
These segments are then joined together to form a continuous network.


## 4. Spare lane(s) (not shown by default)

These are routes that have more than one vehicle lane in either direction and have a cycling potential above the minimum threshold (which varies according to region as it needs to be higher in e.g. Greater London than in rural areas).
This layer can be used to identify where there may be spare lanes on the network that could be reallocated to cycling (or pedestrianisation) beyond those highlighted in the Top ranked new cycleways layer.

## 5. Width >= 10m (not shown by default)

These routes are at least 10m in width and have a cycling potential above the minimum threshold. 
Like the Spare lane(s) layer, this layer is intended to highlight road sections on which increasing space for cycling and walking by reallocating road space may be a viable option.

# Basemaps

There are also five basemaps to choose from. The default basemap is grey and provides an uncluttered view. 
The second basemap option is a thematic map which shows all existing cycleways, including on-road cycle lanes. 
We then have two basemap options showing cycling potential for travel to work and travel to school from the Propensity to Cycle Tool. 
This allows our results to be compared with cycling potentials across the wider road network. 
These both follow the Government Target scenario; this is the same scenario as is used to derive the map layers described above. 
Finally, a satellite image is also available as a basemap.


# Known issues and limitations

<!-- We have developed this evidence base rapidly and -->

- The 'Top ranked new cycleways' highlighted in the map-based results were produced automatically based on a simple score combined cycling potential for school and commute trips.  **The results should be interpreted based on local knowledge and an understanding of the limitations of the data. The results are designed to complement not replace other factors such as feedback from the local community and long-term strategic cycle network plans.**
- The estimates of cycling potential only include school and work travel. Accounting for increases in cycling for other trip purposes such as for shopping and leisure would increase cycling potential substantially.
- The road network data was taken from the Cycling Infrastructure Prioritisation Toolkit (CyIPT) project which was completed in 2017, so may be out of date.
- The results are based on the existing road network. They do not flag potential routes that could be constructed, e.g. along old railway tracks or across open areas.
- The results can highlight major roads that have a speed limit above 40mph that may currently be unsuitable for new cycleways created with light segregation. Roads not controlled by local authorities on the SRN can also be highlighted (although motorways are excluded); we do not alter the results based on who is in control of the roads.
- Other than the Cohesive network layer, which highlights what a joined-up cycle network could look like if roads could be made one way to motor traffic and opened-up to cycling via modal filters, the results do not provide evidence on the full range of interventions. Identifying locations for filtered permeability interventions in residential areas, for example, requires data on residential networks not contained in this analysis.

<!-- Like many projects that have been initiated in response to COVID-19 we have developed the analy -->

If you are interested in the code underlying the project and would like to support the project with technical input, please provide feedback via the [GitHub issue tracker (requires a GitHub account)](https://github.com/cyipt/popupCycleways/issues).
To see and edit the data in OpenStreetMap on which the results are based, see [osm.org](https://www.openstreetmap.org/#map=7/52.486/-2.428&layers=C) (requires an OSM login to [edit the data](https://www.cyclestreets.net/edit/tutorial/)).

# Use the tool

To use the tool, click on the region of interest below and click on the link ([www.cyipt.bike/rapid/west-yorkshire](https://www.cyipt.bike/rapid/west-yorkshire/) for West Yorkshire, for example).
Explore the results in the new page that appears with reference to the guidance on this page and the [Rapid Cycleway Prioritisation Tool report](https://github.com/cyipt/popupCycleways/releases/download/0.3/report.pdf).


```{r}
regions = readRDS("regions_dft.Rds")
regions_centroids = sf::st_point_on_surface(regions)
regions$html_name = tolower(gsub(pattern = " |, ", replacement = "-", regions$Name))
regions$url = paste0("<a href='", regions$html_name ,"' target='_blank'>", regions$Name, "</a>")
```

```{r}
library(leaflet)
s = c(
    `Grey basemap` = "CartoDB.Positron",
    `Coloured basemap` = "Esri.WorldTopoMap",
    `OSM existing cycle provision (CyclOSM)` = "https://b.tile-cyclosm.openstreetmap.fr/cyclosm/{z}/{x}/{y}.png",
    `PCT commuting, Government Target` = "https://npttile.vs.mythic-beasts.com/commute/v2/govtarget/{z}/{x}/{y}.png",
    `PCT schools, Government Target` = "https://npttile.vs.mythic-beasts.com/school/v2/govtarget/{z}/{x}/{y}.png",
    `Satellite image` = "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}'"
  )
tms = c(FALSE, FALSE, FALSE, TRUE, TRUE, FALSE)
# pvars = c("Name", "Level")
Regions = regions %>% 
  mutate(Level = gsub(pattern = "UA", replacement = "Unitary authority", x = Level))
m_regions = tm_shape(Regions) + tm_polygons("Level", popup.vars = FALSE, alpha = 0.5) +
  tm_basemap(server = s, tms = tms)
# + tm_shape(regions_centroids)
# + tm_text("Name", size = 0.7)
tmap_leaflet(m_regions) %>% 
  addPolygons(data = regions, popup = ~url, fillOpacity = 0, weight = 1) 
# library(leaflet)
# leaflet(data = (regions)) %>% 
#   addTiles(urlTemplate = "//b.tile-cyclosm.openstreetmap.fr/cyclosm/{z}/{x}/{y}.png") %>% 
#   addPolygons(popup = ~url, fillOpacity = 0, weight = 1) 
  # addLabelOnlyMarkers(data = regions_centroids, label = ~as.character(Name), 
  #                     labelOptions = labelOptions(noHide = T, direction = 'top', textOnly = T)
  #                     )
```

```{r}
dn = "popupCycleways/release" # dirctory name
built_regions = list.files(dn)
regions = regions %>% 
  filter(stringr::str_detect(string = Name, "Scilly", negate = TRUE))
regions %>%
  sf::st_drop_geometry() %>%
  # filter(html_name %in% built_regions) %>% 
  select(Name, Level, url) %>% 
  arrange(Name) %>% 
  DT::datatable(escape = -4)
```

```{r, eval=FALSE}
dir.create(dn)
region_names_to_build = regions$Name
# region_names_to_build = regions$Name[!regions$html_name %in% built_regions]
sample_to_build_regex = "west of|west y|west mid|hereford|nott|leic|manc|liv|cam|bright|suff"
region_names_to_build = regions %>%
  filter(grepl(pattern = sample_to_build_regex, x = Name, ignore.case = TRUE)) %>%
  pull(Name)
# region_names_to_build = c("West Yorkshire", "Nottingham")
# region_names_to_build = c("Greater London", "Cambridgeshire")
regions_within_names = c("Leicester", "Nottingham", "Derby", "Stoke-on-Trent")
names(regions_within_names) = c(paste0(regions_within_names[1:3], "shire"), "Staffordshire")
regions_containing_names = names(regions_within_names)
names(regions_containing_names) = regions_within_names

rn = "West of England"
for(rn in region_names_to_build) {
  region = regions %>% filter(Name == rn)
  if(rn %in% c(regions_within_names)) {
    region$geometry = sf::st_union(
      region,
      regions %>% filter(Name == regions_containing_names[rn])
      ) %>% sf::st_geometry()
  }
  t = Sys.time()
  message("Building for ", rn)
  d = file.path(dn, region$html_name)
  dir.create(d)
  region_name = region$Name
  # source("code/build.R")
  rmarkdown::render(input = "code/build.R", output_dir = d, knit_root_dir = ".")
  plot(sf::st_geometry(r_lanes_top))
  htmlwidgets::saveWidget(m_leaflet, file.path("~/cyipt/tempCycleways/", d, "m.html"))
  time_to_run = Sys.time() - t
  rmarkdown::render("code/region_index.Rmd", output_file = file.path("~/cyipt/tempCycleways/", d, "index.html"))
  # browseURL(file.path("~/cyipt/tempCycleways/", d, "index.html"))
  sf::write_sf(cycleways, file.path(d, "cycleways.geojson"))
  sf::write_sf(top_routes, file.path(d, "top_routes.geojson"))
  sf::write_sf(key_network_final, file.path(d, "cohesive_network.geojson"))
  sf::write_sf(spare_lanes_final, file.path(d, "spare_lanes.geojson"))
  sf::write_sf(wide_lanes_final, file.path(d, "wide_lanes.geojson"))
  message(round(time_to_run), " minutes to build ", rn)
}
rmarkdown::render("code/index.Rmd", output_dir = dn)
browseURL(file.path(dn, "index.html"))
```

```{r, eval=FALSE}
# rebuild results based on pre-processed data (wip)
for(rn in region_names_to_build) {
  region = regions %>% filter(Name == rn)
  if(rn %in% c(regions_within_names)) {
    region$geometry = sf::st_union(
      region,
      regions %>% filter(Name == regions_containing_names[rn])
      ) %>% sf::st_geometry()
  }
  t = Sys.time()
  message("Building for ", rn)
  d = file.path(dn, region$html_name)
  dir.create(d)
  region_name = region$Name
  # source("code/build.R")
  rmarkdown::render(input = "code/build.R", output_dir = d, knit_root_dir = ".")
  plot(sf::st_geometry(r_lanes_top))
  htmlwidgets::saveWidget(m_leaflet, file.path("~/cyipt/tempCycleways/", d, "m.html"))
  time_to_run = Sys.time() - t
  rmarkdown::render("code/region_index.Rmd", output_file = file.path("~/cyipt/tempCycleways/", d, "index.html"))
  fg = list.files(path = d, pattern = ".geojson", full.names = TRUE)
  file.remove(fg)
  sf::write_sf(cycleways, file.path(d, "cycleways.geojson"))
  sf::write_sf(top_routes, file.path(d, "top_routes.geojson"))
  sf::write_sf(key_network_final, file.path(d, "cohesive_network.geojson"))
  sf::write_sf(spare_lanes_final, file.path(d, "spare_lanes.geojson"))
  sf::write_sf(wide_lanes_final, file.path(d, "wide_lanes.geojson"))
  sf::write_sf(region, file.path(d, "region.geojson"))
  sf::write_sf(lads, file.path(d, "lads.geojson"))
  message(round(time_to_run), " minutes to build ", rn)
}
m =
  tm_shape(lads, name = "Local authority district boundaries") + tm_borders() +
  tm_shape(key_network_final, name = "Cohesive network") +
  tm_lines(lwd = 5, col = "darkgrey", popup.vars = pvars_key) +
  tm_shape(spare_lanes_final, name = labels[2]) +
  tm_lines(legend.col.show = FALSE,
           col = cols_status[2], 
           lwd = 3,
           alpha = 1,
           popup.vars = pvars_spare,
           group = labels[2]
           ) +
  tm_shape(wide_lanes_final, name = labels[2]) +
  tm_lines(legend.col.show = FALSE,
           col = cols_status[3], 
           lwd = 3,
           alpha = 1,
           popup.vars = pvars_spare,
           group = labels[3]
  ) +
  tm_shape(cycleways, name = cycleways_name) + tm_lines(popup.vars = c("surface", "name", "osm_id"), col = "darkgreen", lwd = 1.3) +
  tm_shape(top_routes, name = "Top routes") +
  tm_lines(legend.col.show = FALSE,
           col = cols_status[1], 
           lwd = 5,
           alpha = 1,
           popup.vars = popup.vars
  ) +
  tm_basemap(server = s, tms = tms) +
  tm_add_legend(type = "fill", labels = legend_labels[1:3], col = legend_colours[1:3]) +
  tm_add_legend(type = "fill", labels = labels[2], col = legend_colours[4], group = labels[2]) +
  tm_add_legend(type = "fill", labels = labels[3], col = legend_colours[5], group = labels[3]) +
  tm_scale_bar() 
# m
m_leaflet = tmap_leaflet(m) %>% leaflet::hideGroup(labels[2:3])
```

# Acknowledgments

Many thanks to Dr Malcolm Morgan ([University of Leeds](http://www.leeds.ac.uk/)) and Martin Lucas-Smith ([CycleStreets.net](https://www.cyclestreets.net/)) for providing substantial input into methodological and web development aspects of the project respectively.

Thanks to Jeremy Clarke, Rabina Nawaz, John Sweetman and Richard Mace from the [Department for Transport](https://www.gov.uk/government/organisations/department-for-transport) for vital input into the tool's design.
Thanks to Kevin McCann from [Sustrans](https://www.sustrans.org.uk/) for guidance that improved the tool from a policy perspective.
Thanks to Roger Geffen and others from [CyclingUK](https://www.cyclinguk.org/) for input into prototype versions of the tool.

Thanks to developers of open source software, especially to developers of the [R language](https://www.r-project.org/contributors.html) and the packages [sf](https://github.com/r-spatial/sf) and [tmap](https://github.com/mtennekes/tmap) which underpinned the analysis.
Thanks also to all the contributors to OpenStreetMap who provided open data on which much of the analysis was based, allowing publication of the results as open data under the conditions of the Open Data Commons Open Database License ([ODbL 1.0](https://www.openstreetmap.org/copyright)). Data (c) [OpenStreetMap](https://www.openstreetmap.org) contributors.


# References


