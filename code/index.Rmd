---
title: "Rapid cycleway prioritisation tool"
author: "University of Leeds"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_knit$set(root.dir = "..")
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
```

```{r pkg, include=FALSE}
library(sf)
library(tidyverse)
library(tmap)
tmap_mode("view")
```

```{r, eval=FALSE}
# test build works before running for all:
source("code/build.R")
```

## PRELIMINARY RESULTS

Not quality assured.

Please provide feedback on these preliminary results on this [web form (estimated time to complete: 5 minites)](https://urldefense.proofpoint.com/v2/url?u=https-3A__forms.office.com_Pages_ResponsePage.aspx-3Fid-3DqO3qvR3IzkWGPlIypTW3y9orQ9urif9IgBaXiRS9eEpUM0JCTDRFTTEwSDRVMUs0VVhVWEdGRDA3RS4u&d=DwMCaQ&c=troKkvwivNn_CddsvWCHHPiPoFoTgTGIbXJULvYU158&r=DXeEYtdSYDBZN2DBwEgAHMmX5PQ_ob9r2MynFWta2mU&m=mkyUa3RIC9d5LSrHUqk_WdstQR1OQuTWyYLBecHFMm0&s=dD7GVcQbjZ2AcdCObSe-rNKmLLDBhu98ChFupIIrlJA&e=).

## Introduction

The aim of this tool is to help reveal the locations that have the best potential for pop-up cycleways. It should be used together with local knowledge, to prioritise where to install rapid measures to support safe travel as part of the COVID-19 response. We anticipate that this may be used in the development of a range of temporary, experimental and longer term measures to make the streets safer for us all, as new travel patterns and behaviours emerge in the coming weeks and months.

Maps are available for regions covering the whole of England. 

We have focused on roads which are sufficiently wide that part of the roadspace could potentially be reallocated to pop-up cycleways without preventing traffic movement. In identifying these locations, we have not taken average traffic volumes into account. The pandemic has had a severe impact on movement and traffic flows are currently below normal levels. Instead, we simply identify streets that have multiple vehicle lanes or a carriageway width of greater than 10m. 

Reallocating roadspace is just one of the measures available for transport authorities. Other approaches include modal filters, road closures, and the creation of bus, walking and cycling only streets, as well as speed limits and traffic calming measures. Used strategically, a combination of these measures can promote active travel through the creation of filtered permeability networks and Low Traffic Neighbourhoods. For certain types of area, such as residential zones, this may be the most suitable approach. However, roadspace reallocation is naturally suited to larger arterial-type roads and that is the focus of this tool.

We have used several types of data. The cycling potential of each road is estimated according the Propensity to Cycle Tool's Government Target scenario, which represents the government target to double cycling levels by 2025. Our figures include both travel to work and travel to school, and are based on 2011 Census data. Data on road widths and number of lanes is derived from the Cycling Infrastructure Prioritisation Toolkit.

### Map layers

The maps show five layers. 

1) Key network:

- we have created this to represent the most important cycle corridors. For this layer, we do not take into account the width of the roads, but simply represent them as continuous corridors. This underscores the importance of ensuring that cycle routes are continuous and do not 'give up' at awkward junctions. To derive this layer, we have selected all road segments with cycle potential in the 85th percentile and above, which also belong to classified trunk roads, A roads or B roads. These segments are then joined together to form a continuous network.

2) Existing cycleways (500m +)

- this layer shows existing cycleways. This may be helpful to view in connection with the other layers, because it can reveal where gaps in the existing cycle network could be filled by new infrastructure. This layer does not include some on-road cycle lanes or cycleways less than 500m in length, but these can be viewed in one of the basemap options (see below for more information about the basemaps).

The following three layers are the central results of our analysis, representing the most promising locations for pop-up cycleways.

3) Top routes

- these are the top routes for pop-up cycleways. These are classified by "km cycled", calculated as the length of the route multiplied by the mean cycling potential. All of these road segments will either have more than one vehicle lane in either direction, or be at least 10m in width. The routes are listed in the table below the map, so you can see more information on them. The number of top routes selected is normally 20, with some variation by region.

4) Spare lane(s)

- these are routes that have more than one vehicle lane in either direction and have a cycling potential above the minimum threshold (which varies according to region as it needs to be higher in e.g. Greater London than in rural areas).

5) Width >= 10m  

- these routes are at least 10m in width and have a cycling potential above the minimum threshold. 

Click on any of these layers to see a pop-up box containing more information about the road in question.

### Basemaps

There are also seven basemaps to choose from. The default basemap is grey and provides an uncluttered view. We then have basemap options showing four different scenarios from the Propensity to Cycle Tool. This allows our results to be compared with cycling potentials across the road network. The scenarios available show cycling potential for Commuting (government target), Schools (government targets), Commuting (e-bikes), and schools (Go Dutch).

A further basemap option shows all existing cycleways, including on-road cycle lanes. Finally, a satellite image is also available as a basemap.





```{r}
regions = readRDS("regions_dft.Rds")
regions_centroids = sf::st_point_on_surface(regions)
regions$html_name = tolower(gsub(pattern = " |, ", replacement = "-", regions$Name))
regions$url = paste0("<a href='", regions$html_name ,"' target='_blank'>", regions$Name, "</a>")
```

```{r}
pvars = c("Name", "Level")
tm_shape(regions) + tm_polygons("Level", popup.vars = pvars) + tm_shape(regions_centroids) + tm_text("Name", size = 0.7)
```

```{r}
dn = "popupCycleways/v0.2" # dirctory name
built_regions = list.files(dn)
regions %>%
  sf::st_drop_geometry() %>%
  filter(html_name %in% built_regions) %>% 
  select(Name, Level, url) %>% 
  arrange(Name) %>% 
  DT::datatable(escape = -4)
```

```{r, eval=FALSE}

sample_to_build_regex = "west of|west y|west mid|hereford|nott|leic|manc|liv|cam"
region_names_to_build = regions %>% 
  filter(grepl(pattern = sample_to_build_regex, x = Name, ignore.case = TRUE)) %>% 
  pull(Name)
dir.create(dn)
# region_names_to_build = c("West Yorkshire", "Nottingham")
rmarkdown::render("code/index.Rmd", output_dir = dn)
# region_names_to_build = c("Greater London", "Cambridgeshire")
regions_within_names = c("Leicester", "Nottingham", "Derby", "Stoke-on-Trent")
names(regions_within_names) = c(paste0(regions_within_names[1:3], "shire"), "Staffordshire")
regions_containing_names = names(regions_within_names)
names(regions_containing_names) = regions_within_names

rn = "West of England"
for(rn in region_names_to_build) {
  region = regions %>% filter(Name == rn)
  if(rn %in% c(regions_within_names)) {
    region$geometry = sf::st_union(
      region,
      regions %>% filter(Name == regions_containing_names[rn])
      ) %>% sf::st_geometry()
  }
  t = Sys.time()
  message("Building for ", rn)
  d = file.path(dn, region$html_name)
  dir.create(d)
  region_name = region$Name
  # source("code/build.R")
  rmarkdown::render(input = "code/build.R", output_dir = d, knit_root_dir = ".")
  plot(sf::st_geometry(r_lanes_top))
  htmlwidgets::saveWidget(m_leaflet, file.path("~/cyipt/tempCycleways/", d, "m.html"))
  time_to_run = Sys.time() - t
  rmarkdown::render("code/region_index.Rmd", output_file = file.path("~/cyipt/tempCycleways/", d, "index.html"))
  message(round(time_to_run), " minutes to build ", rn)
}
```




